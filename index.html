<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Naruto Battle Arena</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jockey+One&display=swap');
        body {
            font-family: 'Jockey One', sans-serif;
            background-color: #f1f5f9;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .game-container {
            background-color: #1f2937;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            border-radius: 16px;
            padding: 24px;
            width: 95%;
            max-width: 900px;
            position: relative;
        }
        .canvas-wrapper {
            background: linear-gradient(to bottom, #7dd3fc, #3b82f6);
            border: 4px solid #fcd34d;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .health-bar-container {
            height: 20px;
            background-color: #4b5563;
            border-radius: 9999px;
            overflow: hidden;
            border: 1px solid #1f2937;
        }
        .health-bar {
            height: 100%;
            transition: width 0.3s ease-in-out, background-color 0.3s;
        }
        .chakra-bar {
            height: 100%;
            transition: width 0.3s ease-in-out;
            background-color: #8b5cf6;
        }
        .btn-action {
            font-size: 1.125rem;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            transition: all 0.15s ease-in-out;
            box-shadow: 0 4px #4b5563;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
        }
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px #4b5563;
        }
        .btn-action:active {
            transform: translateY(2px);
            box-shadow: 0 2px #4b5563;
        }
        .btn-taijutsu { background-color: #ef4444; color: white; }
        .btn-ninjutsu { background-color: #3b82f6; color: white; }
        .btn-chakra { background-color: #10b981; color: white; }
        .btn-rocklee { background-color: #15803d; color: white; }
        .btn-gaara { background-color: #7c2d12; color: white; }
        .btn-sakura { background-color: #db2777; color: white; }
        .btn-kakashi { background-color: #374151; color: white; }
        .btn-hinata { background-color: #a855f7; color: white; }
        .btn-itachi { background-color: #000000; color: #ef4444; }
        .message-box {
            min-height: 60px;
            background-color: #1f2937;
            border: 2px solid #fcd34d;
        }
        /* Start Screen Overlay */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(31, 41, 55, 0.95);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .hidden { display: none !important; }
        
        .char-btn {
            border: 2px solid transparent;
            opacity: 0.6;
            transition: all 0.2s;
        }
        .char-btn.selected {
            border-color: #fbbf24; /* Yellow border */
            opacity: 1;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.5);
        }
    </style>
</head>
<body>

<div id="game-container" class="game-container">
    
    <!-- Start Screen Overlay -->
    <div id="startOverlay" class="overlay flex flex-col items-center justify-center bg-gray-900 text-white p-4 overflow-y-auto">
        <h1 class="text-6xl font-bold text-yellow-400 mb-2 tracking-wider" style="font-family: 'Jockey One', sans-serif; text-shadow: 4px 4px 0 #000;">STICK HOKAGE</h1>
        
        <!-- Game Modes (Top Priority) -->
        <div class="flex flex-col items-center space-y-4 w-full mb-6">
            <!-- Standard Modes -->
            <div class="flex space-x-4 items-center">
                <button onclick="startGame('CPU')" class="btn-action bg-yellow-500 text-gray-900 text-lg hover:bg-yellow-600 min-w-[180px] font-bold shadow-lg transform hover:-translate-y-1 transition-transform rounded-lg">
                    VS CPU
                </button>
                <button onclick="startGame('PVP')" class="btn-action bg-red-600 text-white text-lg hover:bg-red-700 min-w-[180px] font-bold shadow-lg transform hover:-translate-y-1 transition-transform rounded-lg">
                    VS PLAYER
                </button>
            </div>

            <!-- Boss Modes -->
            <div class="flex space-x-4 mt-1">
                <button onclick="startBossSelection('Nine Tails')" class="btn-action bg-purple-800 text-white text-xs hover:bg-purple-900 px-4 py-2 font-bold shadow-md transform hover:-translate-y-1 transition-transform border border-purple-500 rounded-full">
                    VS NINE TAILS
                </button>
                <button onclick="startBossSelection('Ten Tails')" class="btn-action bg-gray-800 text-white text-xs hover:bg-gray-900 px-4 py-2 font-bold shadow-md transform hover:-translate-y-1 transition-transform border border-gray-500 rounded-full">
                    VS TEN TAILS
                </button>
            </div>
        </div>

        <!-- Selection Status -->
        <div class="mb-4 text-center">
            <p class="text-gray-400 uppercase tracking-widest text-sm">Select Your Fighter</p>
            <div class="text-2xl mt-1">Selecting: <span id="selecting-player" class="font-bold text-blue-400 animate-pulse">PLAYER 1</span></div>
        </div>

        <!-- Main Selection Area -->
        <div class="flex justify-between items-center w-full max-w-5xl mb-4 px-4">
            
            <!-- Player 1 Preview -->
            <div class="flex flex-col items-center w-1/4 cursor-pointer transition-transform hover:scale-105 scale-105" onclick="setSelectionMode(1)" id="p1-preview">
                <div class="text-blue-400 font-bold text-2xl mb-2">PLAYER 1</div>
                <div id="p1-portrait" class="w-32 h-32 bg-orange-500 border-4 border-blue-500 rounded-xl flex items-center justify-center mb-4 shadow-lg relative overflow-hidden">
                    <span class="text-5xl">ü¶ä</span>
                </div>
                <div id="p1-name" class="text-3xl font-bold text-white tracking-tighter">NARUTO</div>
            </div>

            <!-- Character Grid -->
            <div class="grid grid-cols-5 gap-2 mx-4">
                <!-- Naruto -->
                <div onclick="selectChar('Naruto')" class="relative cursor-pointer w-14 h-14 bg-orange-600 hover:bg-orange-500 border-2 border-gray-700 hover:border-white rounded-lg flex flex-col items-center justify-center transition-all transform hover:scale-110 shadow-lg group">
                    <span class="text-2xl mb-1">ü¶ä</span>
                    <span class="text-[10px] font-bold uppercase">Naruto</span>
                    <div id="p1-indicator-Naruto" class="p1-indicator absolute top-0 left-0 bg-blue-600 text-white text-xs font-bold px-2 py-0.5 rounded-br shadow-md">P1</div>
                    <div id="p2-indicator-Naruto" class="p2-indicator absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-bl shadow-md hidden">P2</div>
                </div>
                <!-- Sasuke -->
                <div onclick="selectChar('Sasuke')" class="relative cursor-pointer w-14 h-14 bg-blue-700 hover:bg-blue-600 border-2 border-gray-700 hover:border-white rounded-lg flex flex-col items-center justify-center transition-all transform hover:scale-110 shadow-lg group">
                    <span class="text-2xl mb-1">‚ö°</span>
                    <span class="text-[10px] font-bold uppercase">Sasuke</span>
                    <div id="p1-indicator-Sasuke" class="p1-indicator absolute top-0 left-0 bg-blue-600 text-white text-xs font-bold px-2 py-0.5 rounded-br shadow-md hidden">P1</div>
                    <div id="p2-indicator-Sasuke" class="p2-indicator absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-bl shadow-md">P2</div>
                </div>
                <!-- Rock Lee -->
                <div onclick="selectChar('Rock Lee')" class="relative cursor-pointer w-14 h-14 bg-green-700 hover:bg-green-600 border-2 border-gray-700 hover:border-white rounded-lg flex flex-col items-center justify-center transition-all transform hover:scale-110 shadow-lg group">
                    <span class="text-2xl mb-1">üëä</span>
                    <span class="text-[10px] font-bold uppercase">Rock Lee</span>
                    <div id="p1-indicator-Rock Lee" class="p1-indicator absolute top-0 left-0 bg-blue-600 text-white text-xs font-bold px-2 py-0.5 rounded-br shadow-md hidden">P1</div>
                    <div id="p2-indicator-Rock Lee" class="p2-indicator absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-bl shadow-md hidden">P2</div>
                </div>
                <!-- Gaara -->
                <div onclick="selectChar('Gaara')" class="relative cursor-pointer w-14 h-14 bg-red-900 hover:bg-red-800 border-2 border-gray-700 hover:border-white rounded-lg flex flex-col items-center justify-center transition-all transform hover:scale-110 shadow-lg group">
                    <span class="text-2xl mb-1">üè∫</span>
                    <span class="text-[10px] font-bold uppercase">Gaara</span>
                    <div id="p1-indicator-Gaara" class="p1-indicator absolute top-0 left-0 bg-blue-600 text-white text-xs font-bold px-2 py-0.5 rounded-br shadow-md hidden">P1</div>
                    <div id="p2-indicator-Gaara" class="p2-indicator absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-bl shadow-md hidden">P2</div>
                </div>
                <!-- Sakura -->
                <div onclick="selectChar('Sakura')" class="relative cursor-pointer w-14 h-14 bg-pink-600 hover:bg-pink-500 border-2 border-gray-700 hover:border-white rounded-lg flex flex-col items-center justify-center transition-all transform hover:scale-110 shadow-lg group">
                    <span class="text-2xl mb-1">üå∏</span>
                    <span class="text-[10px] font-bold uppercase">Sakura</span>
                    <div id="p1-indicator-Sakura" class="p1-indicator absolute top-0 left-0 bg-blue-600 text-white text-xs font-bold px-2 py-0.5 rounded-br shadow-md hidden">P1</div>
                    <div id="p2-indicator-Sakura" class="p2-indicator absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-bl shadow-md hidden">P2</div>
                </div>
                <!-- Kakashi -->
                <div onclick="selectChar('Kakashi')" class="relative cursor-pointer w-14 h-14 bg-gray-600 hover:bg-gray-500 border-2 border-gray-700 hover:border-white rounded-lg flex flex-col items-center justify-center transition-all transform hover:scale-110 shadow-lg group">
                    <span class="text-2xl mb-1">‚ö°</span>
                    <span class="text-[10px] font-bold uppercase">Kakashi</span>
                    <div id="p1-indicator-Kakashi" class="p1-indicator absolute top-0 left-0 bg-blue-600 text-white text-xs font-bold px-2 py-0.5 rounded-br shadow-md hidden">P1</div>
                    <div id="p2-indicator-Kakashi" class="p2-indicator absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-bl shadow-md hidden">P2</div>
                </div>
                <!-- Hinata -->
                <div onclick="selectChar('Hinata')" class="relative cursor-pointer w-14 h-14 bg-purple-400 hover:bg-purple-300 border-2 border-gray-700 hover:border-white rounded-lg flex flex-col items-center justify-center transition-all transform hover:scale-110 shadow-lg group">
                    <span class="text-2xl mb-1">üëÅÔ∏è</span>
                    <span class="text-[10px] font-bold uppercase">Hinata</span>
                    <div id="p1-indicator-Hinata" class="p1-indicator absolute top-0 left-0 bg-blue-600 text-white text-xs font-bold px-2 py-0.5 rounded-br shadow-md hidden">P1</div>
                    <div id="p2-indicator-Hinata" class="p2-indicator absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-bl shadow-md hidden">P2</div>
                </div>
                <!-- Itachi -->
                <div onclick="selectChar('Itachi')" class="relative cursor-pointer w-14 h-14 bg-black hover:bg-gray-900 border-2 border-gray-700 hover:border-red-500 rounded-lg flex flex-col items-center justify-center transition-all transform hover:scale-110 shadow-lg group">
                    <span class="text-2xl mb-1">üåë</span>
                    <span class="text-[10px] font-bold uppercase text-red-500">Itachi</span>
                    <div id="p1-indicator-Itachi" class="p1-indicator absolute top-0 left-0 bg-blue-600 text-white text-xs font-bold px-2 py-0.5 rounded-br shadow-md hidden">P1</div>
                    <div id="p2-indicator-Itachi" class="p2-indicator absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-bl shadow-md hidden">P2</div>
                </div>
                <!-- Madara -->
                <div onclick="selectChar('Madara')" class="relative cursor-pointer w-14 h-14 bg-red-800 hover:bg-red-700 border-2 border-gray-700 hover:border-red-500 rounded-lg flex flex-col items-center justify-center transition-all transform hover:scale-110 shadow-lg group">
                    <span class="text-2xl mb-1">‚öîÔ∏è</span>
                    <span class="text-[10px] font-bold uppercase text-white">Madara</span>
                    <div id="p1-indicator-Madara" class="p1-indicator absolute top-0 left-0 bg-blue-600 text-white text-xs font-bold px-2 py-0.5 rounded-br shadow-md hidden">P1</div>
                    <div id="p2-indicator-Madara" class="p2-indicator absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-bl shadow-md hidden">P2</div>
                </div>
                <!-- Minato -->
                <div onclick="selectChar('Minato')" class="relative cursor-pointer w-14 h-14 bg-yellow-400 hover:bg-yellow-300 border-2 border-gray-700 hover:border-white rounded-lg flex flex-col items-center justify-center transition-all transform hover:scale-110 shadow-lg group">
                    <span class="text-2xl mb-1">‚ö°</span>
                    <span class="text-[10px] font-bold uppercase text-black">Minato</span>
                    <div id="p1-indicator-Minato" class="p1-indicator absolute top-0 left-0 bg-blue-600 text-white text-xs font-bold px-2 py-0.5 rounded-br shadow-md hidden">P1</div>
                    <div id="p2-indicator-Minato" class="p2-indicator absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-bl shadow-md hidden">P2</div>
                </div>
                <!-- Obito -->
                <div onclick="selectChar('Obito')" class="relative cursor-pointer w-14 h-14 bg-indigo-900 hover:bg-indigo-800 border-2 border-gray-700 hover:border-white rounded-lg flex flex-col items-center justify-center transition-all transform hover:scale-110 shadow-lg group">
                    <span class="text-2xl mb-1">üåÄ</span>
                    <span class="text-[10px] font-bold uppercase text-white">Obito</span>
                    <div id="p1-indicator-Obito" class="p1-indicator absolute top-0 left-0 bg-blue-600 text-white text-xs font-bold px-2 py-0.5 rounded-br shadow-md hidden">P1</div>
                    <div id="p2-indicator-Obito" class="p2-indicator absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-bl shadow-md hidden">P2</div>
                </div>
                <!-- Pain -->
                <div onclick="selectChar('Pain')" class="relative cursor-pointer w-14 h-14 bg-gray-800 hover:bg-gray-700 border-2 border-gray-700 hover:border-orange-500 rounded-lg flex flex-col items-center justify-center transition-all transform hover:scale-110 shadow-lg group">
                    <span class="text-2xl mb-1">üìç</span>
                    <span class="text-[10px] font-bold uppercase text-orange-500">Pain</span>
                    <div id="p1-indicator-Pain" class="p1-indicator absolute top-0 left-0 bg-blue-600 text-white text-xs font-bold px-2 py-0.5 rounded-br shadow-md hidden">P1</div>
                    <div id="p2-indicator-Pain" class="p2-indicator absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-bl shadow-md hidden">P2</div>
                </div>
                <!-- Random -->
                <div onclick="selectRandomChar()" class="relative cursor-pointer w-14 h-14 bg-purple-900 hover:bg-purple-800 border-2 border-gray-700 hover:border-white rounded-lg flex flex-col items-center justify-center transition-all transform hover:scale-110 shadow-lg group">
                    <span class="text-2xl mb-1">?</span>
                    <span class="text-[10px] font-bold uppercase">Random</span>
                </div>
            </div>

            <!-- Player 2 Preview -->
            <div class="flex flex-col items-center w-1/4 cursor-pointer transition-transform hover:scale-105" onclick="setSelectionMode(2)" id="p2-preview">
                <div class="text-red-400 font-bold text-2xl mb-2">PLAYER 2</div>
                <div id="p2-portrait" class="w-32 h-32 bg-blue-600 border-4 border-red-500 rounded-xl flex items-center justify-center mb-4 shadow-lg relative overflow-hidden">
                    <span class="text-5xl">‚ö°</span>
                </div>
                <div id="p2-name" class="text-3xl font-bold text-white tracking-tighter">SASUKE</div>
            </div>
        </div>

        <!-- Arena Selection -->
        <div class="flex flex-col items-center mt-4 w-full">
            <h2 class="text-gray-400 text-xs uppercase tracking-widest mb-2">Select Arena</h2>
            <div class="flex space-x-4">
                <button onclick="selectArena('Valley')" id="arena-Valley" class="px-4 py-1 rounded bg-blue-900 border-2 border-blue-500 text-white hover:bg-blue-800 transition-colors selected ring-2 ring-yellow-400 text-sm">Valley</button>
                <button onclick="selectArena('Forest')" id="arena-Forest" class="px-4 py-1 rounded bg-green-900 border-2 border-green-500 text-white hover:bg-green-800 transition-colors text-sm">Forest</button>
                <button onclick="selectArena('Leaf')" id="arena-Leaf" class="px-4 py-1 rounded bg-orange-600 border-2 border-orange-400 text-white hover:bg-orange-500 transition-colors text-sm">Leaf</button>
            </div>
        </div>
        
    <!-- Team Selection Display (Hidden by default) -->
    <div id="team-display" class="hidden mt-4 flex space-x-2">
        <!-- Filled by JS -->
    </div>
    </div>

    <h1 class="text-4xl text-center mb-6 text-yellow-400">STICK HOKAGE: BATTLE ARENA</h1>    <!-- Team Status Display (Boss Mode) -->
    <div id="battle-team-display" class="flex justify-center space-x-2 mb-4 hidden">
        <!-- Filled by JS -->
    </div>

    <div class="flex justify-between items-start mb-4 text-white">
        <div id="player-a-stats" class="w-2/5 p-3 bg-gray-700 rounded-lg shadow-inner">
            <h2 id="nameA" class="text-xl text-red-400 mb-2">Player A</h2>
            <div class="mb-1">
                <p>HP: <span id="hpA">100</span> / <span id="maxHpA">100</span></p>
                <div class="health-bar-container"><div id="healthBarA" class="health-bar bg-red-500" style="width: 100%;"></div></div>
            </div>
            <div>
                <p>Chakra: <span id="chakraA">50</span> / <span id="maxChakraA">50</span></p>
                <div class="health-bar-container"><div id="chakraBarA" class="chakra-bar" style="width: 100%;"></div></div>
            </div>
        </div>

        <div id="player-b-stats" class="w-2/5 p-3 bg-gray-700 rounded-lg shadow-inner text-right">
            <h2 id="nameB" class="text-xl text-blue-400 mb-2">Player B</h2>
            <div class="mb-1">
                <p>HP: <span id="hpB">100</span> / <span id="maxHpB">100</span></p>
                <div class="health-bar-container"><div id="healthBarB" class="health-bar bg-red-500" style="width: 100%;"></div></div>
            </div>
            <div>
                <p>Chakra: <span id="chakraB">50</span> / <span id="maxChakraB">50</span></p>
                <div class="health-bar-container"><div id="chakraBarB" class="chakra-bar" style="width: 100%;"></div></div>
            </div>
        </div>
    </div>

    <div class="canvas-wrapper mb-4 relative">
        <canvas id="battleCanvas" width="850" height="300"></canvas>
        <div id="messageBox" class="message-box absolute bottom-0 left-0 w-full p-2 text-center text-yellow-300 text-lg rounded-b-lg border-t-0">
            Select your fighters!
        </div>
    </div>

    <div id="controls" class="flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-4">
        <div id="controlsA" class="flex justify-center space-x-3 w-full md:w-1/2">
            <button id="btnTaijutsuA" class="btn-action btn-taijutsu w-1/3" onclick="handleAction('A', 'Taijutsu')">Taijutsu</button>
            <button id="btnNinjutsuA" class="btn-action btn-ninjutsu w-1/3" onclick="handleAction('A', 'Ninjutsu')">Ninjutsu</button>
            <button id="btnChakraA" class="btn-action btn-chakra w-1/3" onclick="handleAction('A', 'Chakra')">Focus</button>
        </div>
        <!-- Controls B (Hidden in CPU mode) -->
        <div id="controlsB" class="flex justify-center space-x-3 w-full md:w-1/2">
            <button id="btnTaijutsuB" class="btn-action btn-taijutsu w-1/3" onclick="handleAction('B', 'Taijutsu')">Taijutsu</button>
            <button id="btnNinjutsuB" class="btn-action btn-ninjutsu w-1/3" onclick="handleAction('B', 'Ninjutsu')">Ninjutsu</button>
            <button id="btnChakraB" class="btn-action btn-chakra w-1/3" onclick="handleAction('B', 'Chakra')">Focus</button>
        </div>
    </div>
</div>

<script>
    (function() {
        // --- Game Setup ---
        const canvas = document.getElementById('battleCanvas');
        const ctx = canvas.getContext('2d');
        const W = canvas.width;
        const H = canvas.height;
        const GROUND_Y = H - 50; // Raised ground slightly for feet
        const CHAR_SCALE = 1;
        const CHAR_SIZE = 20; // Used as a generic size reference for animation offsets

        // Menu State
        let p1Selection = 'Naruto';
        let p2Selection = 'Sasuke';
        let arenaSelection = 'Valley';

        let gameState = {
            mode: 'PVP', 
            arena: 'Valley', 
            playerA: { hp: 100, maxHp: 100, chakra: 50, maxChakra: 50, x: W * 0.2, y: GROUND_Y, color: '#000000', name: 'Naruto', pose: 'idle', isCurseMark: false, isThreeTails: false }, 
            playerB: { hp: 100, maxHp: 100, chakra: 50, maxChakra: 50, x: W * 0.8, y: GROUND_Y, color: '#000000', name: 'Sasuke', pose: 'idle', isCurseMark: false, isThreeTails: false }, 
            teamA: [],
            teamIndex: 0,
            turn: 'A',
            isAnimating: false,
            message: "",
            effects: [], 
            floatingTexts: []
        };

        const MOVES = {
            'Taijutsu': { cost: 0, damage: 10, msg: "executes a quick combo!" },
            'Chakra': { cost: 0, chakraGain: 25, msg: "focuses Chakra!" },
            'Rasengan': { cost: 40, damage: 50, ninjutsuMsg: "shoots a massive RASENGAN!" }, 
            'Chidori': { cost: 40, damage: 50, ninjutsuMsg: "pierces with CHIDORI!" },
            'Primary Lotus': { cost: 40, damage: 55, ninjutsuMsg: "opens the Gates! PRIMARY LOTUS!" },
            'Sand Coffin': { cost: 40, damage: 50, ninjutsuMsg: "crushes with SAND COFFIN!" },
            'Sand Burial': { cost: 100, damage: 100, ninjutsuMsg: "buries the enemy with GIANT SAND BURIAL!" },
            'Super Punch': { cost: 40, damage: 50, ninjutsuMsg: "lands a devastating SUPER PUNCH!" },
            '100 Healings Smash': { cost: 100, damage: 90, heal: 40, ninjutsuMsg: "activates 100 Healings! SHANNARO!" },
            'Sharingan': { cost: 100, damage: 100, selfDamage: 20, ninjutsuMsg: "unleashes the power of the SHARINGAN!" },
            'Lightning Blade': { cost: 40, damage: 55, ninjutsuMsg: "strikes with LIGHTNING BLADE!" },
            'Kamui': { cost: 100, damage: 100, ninjutsuMsg: "warps space with KAMUI!" },
            'Beast Ball': { cost: 100, damage: 101, selfDamage: 25, ninjutsuMsg: "fires a TAILED BEAST BOMB!" },
            '8 Trigrams': { cost: 40, damage: 55, ninjutsuMsg: "strikes with 8 TRIGRAMS 64 PALMS!" },
            'Twin Lion Fists': { cost: 100, damage: 100, ninjutsuMsg: "strikes with TWIN LION FISTS!" },
            'Fireball': { cost: 40, damage: 55, ninjutsuMsg: "blows a massive FIREBALL!" },
            'Tsukuyomi': { cost: 100, damage: 120, ninjutsuMsg: "traps the enemy in TSUKUYOMI!" },
            'Majestic Destroyer Flame': { cost: 40, damage: 60, ninjutsuMsg: "unleashes MAJESTIC DESTROYER FLAME!" },
            'Perfect Susanoo': { cost: 100, damage: 120, ninjutsuMsg: "summons PERFECT SUSANOO!" },
            'Meteor Drop': { cost: 100, damage: 150, selfDamage: 30, ninjutsuMsg: "summons a METEOR!" },
            'Flying Raijin': { cost: 40, damage: 60, ninjutsuMsg: "flashes with FLYING RAIJIN!" },
            'Rasengan Barrage': { cost: 100, damage: 130, ninjutsuMsg: "unleashes RASENGAN BARRAGE!" },
            'Kamui Strike': { cost: 45, damage: 50, ninjutsuMsg: "phases and STRIKES!" },
            'Gedo Statue': { cost: 100, damage: 140, ninjutsuMsg: "summons the GEDO STATUE!" },
            'Almighty Push': { cost: 40, damage: 60, ninjutsuMsg: "blasts with ALMIGHTY PUSH!" },
            'Thunder Strike': { cost: 100, damage: 100, ninjutsuMsg: "calls down a THUNDER STRIKE!" },
            'Planetary Devastation': { cost: 100, damage: 150, ninjutsuMsg: "creates PLANETARY DEVASTATION!" },
            // 3rd Form Moves
            'Six Paths Rasenshuriken': { cost: 100, damage: 150, ninjutsuMsg: "throws a SIX PATHS RASENSHURIKEN!" },
            'Indra\'s Arrow': { cost: 100, damage: 150, ninjutsuMsg: "fires INDRA'S ARROW!" },
            'Night Guy': { cost: 100, damage: 160, selfDamage: 50, ninjutsuMsg: "unleashes NIGHT GUY!" },
            'Gold Sand Tsunami': { cost: 100, damage: 140, ninjutsuMsg: "crushes with GOLD SAND TSUNAMI!" },
            'Katsuyu Acid': { cost: 100, damage: 130, heal: 50, ninjutsuMsg: "spits KATSUYU ACID!" },
            'Kamui Shuriken': { cost: 100, damage: 150, ninjutsuMsg: "throws KAMUI SHURIKEN!" },
            'Silver Wheel': { cost: 100, damage: 140, ninjutsuMsg: "strikes with SILVER WHEEL REINCARNATION!" },
            'Yasaka Magatama': { cost: 100, damage: 140, ninjutsuMsg: "throws YASAKA MAGATAMA!" },
            // Boss Moves
            'Nine Tails Whip': { cost: 0, damage: 30, msg: "smashes with its TAILS!" },
            'Slash': { cost: 0, damage: 25, msg: "slashes with GIANT CLAWS!" },
            'Giant Beast Bomb': { cost: 50, damage: 80, ninjutsuMsg: "fires a MASSIVE BEAST BOMB!" },
            // Ten Tails Moves
            'Ten Tails Swipe': { cost: 0, damage: 40, msg: "swipes with its GIANT HAND!" },
            'Cataclysm': { cost: 0, damage: 50, msg: "causes a CATACLYSM!" },
            'God Tree Beam': { cost: 50, damage: 120, ninjutsuMsg: "fires a GOD TREE BEAM!" }
        };

        // --- Menu Logic ---
        let selectionMode = 1;
        let isBossModeSelection = false;
        let teamSelection = [];
        let selectedBoss = 'Nine Tails';

        window.setSelectionMode = function(mode) {
            selectionMode = mode;
            isBossModeSelection = false;
            document.getElementById('team-display').classList.add('hidden');
            updateSelectionUI();
        };

        window.startBossSelection = function(bossName) {
            selectedBoss = bossName || 'Nine Tails';
            isBossModeSelection = true;
            teamSelection = [];
            document.getElementById('team-display').classList.remove('hidden');
            document.getElementById('team-display').innerHTML = '';
            updateSelectionUI();
        };

        window.selectRandomChar = function() {
            const chars = ['Naruto', 'Sasuke', 'Rock Lee', 'Gaara', 'Sakura', 'Kakashi', 'Hinata', 'Itachi', 'Madara', 'Minato', 'Obito', 'Pain'];
            const randomChar = chars[Math.floor(Math.random() * chars.length)];
            selectChar(randomChar);
        };

        window.selectChar = function(charName) {
            if (isBossModeSelection) {
                if (teamSelection.includes(charName)) return;
                
                const maxTeamSize = selectedBoss === 'Nine Tails' ? 2 : 5;

                if (teamSelection.length < maxTeamSize) {
                    teamSelection.push(charName);
                    
                    // Update Team Display
                    const teamDisplay = document.getElementById('team-display');
                    const slot = document.createElement('div');
                    slot.className = "w-12 h-12 bg-gray-700 border border-gray-500 rounded flex items-center justify-center text-xl";
                    // Simple icon mapping
                    const icons = {'Naruto':'ü¶ä','Sasuke':'‚ö°','Rock Lee':'üëä','Gaara':'üè∫','Sakura':'üå∏','Kakashi':'‚ö°','Hinata':'üëÅÔ∏è','Itachi':'üåë','Madara':'‚öîÔ∏è','Minato':'‚ö°','Obito':'üåÄ','Pain':'üìç'};
                    slot.textContent = icons[charName];
                    teamDisplay.appendChild(slot);

                    if (teamSelection.length === maxTeamSize) {
                        setTimeout(() => startGame('BOSS'), 500);
                    } else {
                        updateSelectionUI();
                    }
                }
            } else {
                if (selectionMode === 1) {
                    p1Selection = charName;
                    selectionMode = 2; // Auto advance
                } else {
                    p2Selection = charName;
                }
                updateSelectionUI();
            }
        };

        function updateSelectionUI() {
            if (isBossModeSelection) {
                const maxTeamSize = selectedBoss === 'Nine Tails' ? 2 : 5;
                document.getElementById('selecting-player').textContent = `TEAM MEMBER ${teamSelection.length + 1}/${maxTeamSize}`;
                document.getElementById('selecting-player').className = "font-bold text-purple-400 animate-pulse";
                return;
            }

            // Update Names
            document.getElementById('p1-name').textContent = p1Selection.toUpperCase();
            document.getElementById('p2-name').textContent = p2Selection.toUpperCase();
            
            // Char Data for Portraits
            const charData = {
                'Naruto': { color: 'bg-orange-500', icon: 'ü¶ä' },
                'Sasuke': { color: 'bg-blue-700', icon: '‚ö°' },
                'Rock Lee': { color: 'bg-green-700', icon: 'üëä' },
                'Gaara': { color: 'bg-red-900', icon: 'üè∫' },
                'Sakura': { color: 'bg-pink-600', icon: 'üå∏' },
                'Kakashi': { color: 'bg-gray-600', icon: '‚ö°' },
                'Hinata': { color: 'bg-purple-400', icon: 'üëÅÔ∏è' },
                'Itachi': { color: 'bg-black', icon: 'üåë' },
                'Madara': { color: 'bg-red-800', icon: '‚öîÔ∏è' },
                'Minato': { color: 'bg-yellow-400', icon: '‚ö°' },
                'Obito': { color: 'bg-indigo-900', icon: 'üåÄ' },
                'Pain': { color: 'bg-gray-800', icon: 'üìç' }
            };
            
            // Update P1 Portrait
            const p1Data = charData[p1Selection];
            const p1El = document.getElementById('p1-portrait');
            p1El.className = `w-40 h-40 border-4 border-blue-500 rounded-xl flex items-center justify-center mb-4 shadow-lg relative overflow-hidden ${p1Data.color}`;
            p1El.innerHTML = `<span class="text-6xl">${p1Data.icon}</span>`;

            // Update P2 Portrait
            const p2Data = charData[p2Selection];
            const p2El = document.getElementById('p2-portrait');
            p2El.className = `w-40 h-40 border-4 border-red-500 rounded-xl flex items-center justify-center mb-4 shadow-lg relative overflow-hidden ${p2Data.color}`;
            p2El.innerHTML = `<span class="text-6xl">${p2Data.icon}</span>`;

            // Update Grid Indicators
            document.querySelectorAll('.p1-indicator').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.p2-indicator').forEach(el => el.classList.add('hidden'));
            
            const p1Id = p1Selection; 
            const p2Id = p2Selection;
            
            const p1Ind = document.getElementById(`p1-indicator-${p1Id}`);
            if(p1Ind) p1Ind.classList.remove('hidden');
            
            const p2Ind = document.getElementById(`p2-indicator-${p2Id}`);
            if(p2Ind) p2Ind.classList.remove('hidden');

            // Update Status Text
            const selText = document.getElementById('selecting-player');
            const p1Prev = document.getElementById('p1-preview');
            const p2Prev = document.getElementById('p2-preview');

            if(selectionMode === 1) {
                selText.textContent = "PLAYER 1";
                selText.className = "font-bold text-blue-400 animate-pulse";
                p1Prev.classList.add('scale-105', 'ring-4', 'ring-blue-500', 'rounded-xl');
                p2Prev.classList.remove('scale-105', 'ring-4', 'ring-red-500', 'rounded-xl');
            } else {
                selText.textContent = "PLAYER 2";
                selText.className = "font-bold text-red-400 animate-pulse";
                p1Prev.classList.remove('scale-105', 'ring-4', 'ring-blue-500', 'rounded-xl');
                p2Prev.classList.add('scale-105', 'ring-4', 'ring-red-500', 'rounded-xl');
            }
        }

        window.selectArena = function(arena) {
            arenaSelection = arena;
            ['Valley', 'Forest', 'Leaf'].forEach(a => {
                const el = document.getElementById(`arena-${a}`);
                if(el) el.classList.remove('ring-2', 'ring-yellow-400');
            });
            const target = document.getElementById(`arena-${arena}`);
            if(target) target.classList.add('ring-2', 'ring-yellow-400');
        };

        window.startGame = function(mode) {
            gameState.mode = mode;
            if (mode === 'BOSS') {
                gameState.teamA = teamSelection.map(name => ({
                    hp: 100, maxHp: 100, chakra: 50, maxChakra: 50, x: W * 0.2, y: GROUND_Y, color: '#000000', name: name, pose: 'idle', isCurseMark: false, isThreeTails: false, isNinthGate: false, isShukaku: false, is100Healings: false, isMangekyou: false, isTwinLion: false, isSusanoo: false
                }));
                gameState.teamIndex = 0;
                gameState.playerA = gameState.teamA[0];
                
                let bossHp = 1000;
                if (selectedBoss === 'Ten Tails') bossHp = 2000;
                
                gameState.playerB = { hp: bossHp, maxHp: bossHp, chakra: 1000, maxChakra: 1000, x: W * 0.7, y: GROUND_Y, color: '#f97316', name: selectedBoss, pose: 'idle' };
            } else {
                gameState.playerA.name = p1Selection;
                gameState.playerB.name = p2Selection;
            }
            gameState.arena = arenaSelection;
            document.getElementById('startOverlay').classList.add('hidden');
            window.resetGame();
        };

        // --- Helper Drawing Functions ---
        function spawnFloatingText(x, y, text, color, isCritical = false) {
            gameState.floatingTexts.push({
                x: x, y: y, text: text, color: color, life: 60, maxLife: 60, isCritical: isCritical
            });
        }

        function drawFloatingTexts(ctx) {
            ctx.save();
            gameState.floatingTexts = gameState.floatingTexts.filter(ft => {
                const progress = ft.life / ft.maxLife;
                ctx.globalAlpha = Math.max(0, progress);
                ctx.fillStyle = ft.color;
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 3;
                const currentY = ft.y - (60 - ft.life) * 1; 
                const fontSize = ft.isCritical ? 32 : 20;
                ctx.font = `bold ${fontSize}px "Jockey One"`;
                ctx.textAlign = 'center';
                ctx.strokeText(ft.text, ft.x, currentY);
                ctx.fillText(ft.text, ft.x, currentY);
                ft.life--;
                return ft.life > 0;
            });
            ctx.restore();
        }

        function drawWings(x, y, direction) {
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(direction, 1); // Scale so +X is Front

            // Helper for hand-wing shape
            function drawWingShape(color, rot) {
                ctx.save();
                ctx.rotate(rot);
                ctx.fillStyle = color;
                ctx.strokeStyle = '#111827';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(0, 0);
                // Hand-like shape extending backwards (-X)
                ctx.bezierCurveTo(-30, -50, -80, -60, -120, -40); // Top
                ctx.bezierCurveTo(-90, -30, -60, -20, -40, -10);
                ctx.bezierCurveTo(-100, 0, -130, 20, -140, 50); // Middle
                ctx.bezierCurveTo(-90, 30, -60, 20, -40, 10);
                ctx.bezierCurveTo(-80, 70, -90, 100, -100, 120); // Bottom
                ctx.bezierCurveTo(-60, 80, -30, 50, 0, 20);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
                ctx.restore();
            }

            // Wing 1 (Far/Back)
            drawWingShape('#374151', -0.2);

            // Wing 2 (Near/Front)
            drawWingShape('#4b5563', 0.1);

            ctx.restore();
        }

        function drawThreeTails(x, y, direction) {
            ctx.save();
            
            // Draw three tails
            for (let i = 0; i < 3; i++) {
                ctx.strokeStyle = '#dc2626';
                ctx.fillStyle = '#ef4444';
                ctx.lineWidth = 3;
                
                const tailAngle = (i - 1) * 0.4; // Spread the tails
                const tailX = x - (60 * direction);
                const tailY = y - 10;
                
                ctx.beginPath();
                ctx.moveTo(x, y);
                
                // Create flowing tail shape
                const cp1x = x - (40 * direction);
                const cp1y = y - 20 + (i * 10);
                const cp2x = x - (80 * direction);
                const cp2y = y + (i * 15);
                const endX = x - (100 * direction);
                const endY = y + 10 + (i * 20);
                
                ctx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, endX, endY);
                ctx.lineTo(endX - (10 * direction), endY - 5);
                ctx.bezierCurveTo(cp2x - (10 * direction), cp2y, cp1x - (5 * direction), cp1y, x, y - 5);
                
                ctx.fill();
                ctx.stroke();
            }
            
            // Orange energy aura around character
            ctx.fillStyle = 'rgba(249, 115, 22, 0.3)';
            ctx.beginPath();
            ctx.arc(x, y - 30, 40, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.restore();
        }

        function drawNineTails(ctx, x, y, direction, pose) {
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(direction, 1); // Face direction

            // Scale up significantly
            const scale = 3.5;
            ctx.scale(scale, scale);

            // Colors
            const furColor = '#ea580c'; // Darker Orange
            const darkFur = '#9a3412'; // Deep Red-Orange
            const eyeColor = '#ef4444'; // Red
            const glowColor = 'rgba(239, 68, 68, 0.5)';

            // Aura
            ctx.shadowColor = '#f97316';
            ctx.shadowBlur = 15;

            // --- Tails (9 of them! - Drawn FIRST to be behind body) ---
            ctx.strokeStyle = furColor;
            ctx.lineWidth = 5;
            ctx.lineCap = 'round';
            ctx.shadowColor = '#c2410c';
            ctx.shadowBlur = 5;
            
            for(let i=0; i<9; i++) {
                ctx.beginPath();
                const angle = (i * 0.2) - 0.8;
                const tailX = 20;
                const tailY = -15;
                
                // Waving animation
                const wave = Math.sin(Date.now() / 300 + i) * 8;
                const wave2 = Math.cos(Date.now() / 250 + i) * 5;
                
                ctx.moveTo(tailX, tailY);
                ctx.bezierCurveTo(
                    tailX + 20, tailY - 30 + (i*4), 
                    tailX + 40 + wave, tailY - 40 + (i*6) + wave2, 
                    tailX + 60 + wave, tailY - 20 + (i*8) + wave
                );
                ctx.stroke();
            }
            ctx.shadowBlur = 0;

            // Body (Crouched Fox)
            ctx.fillStyle = furColor;
            ctx.beginPath();
            ctx.ellipse(0, -15, 25, 15, 0, 0, Math.PI * 2);
            ctx.fill();

            // Head
            ctx.save();
            ctx.translate(-20, -25);
            
            // Ears (Longer, sharper)
            ctx.beginPath();
            ctx.moveTo(0, 0); ctx.lineTo(2, -20); ctx.lineTo(10, 0);
            ctx.moveTo(15, 0); ctx.lineTo(23, -20); ctx.lineTo(25, 0);
            ctx.fill();
            
            // Snout
            ctx.beginPath();
            ctx.ellipse(12, 5, 15, 12, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Black markings around eyes
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.ellipse(8, 2, 4, 6, -0.2, 0, Math.PI*2);
            ctx.ellipse(17, 2, 4, 6, 0.2, 0, Math.PI*2);
            ctx.fill();

            // Eyes (Glowing)
            ctx.shadowColor = '#ef4444';
            ctx.shadowBlur = 10;
            ctx.fillStyle = '#fff'; // White center
            ctx.beginPath();
            ctx.moveTo(5, 0); ctx.lineTo(10, 2); ctx.lineTo(5, 4); // Left Eye
            ctx.moveTo(15, 0); ctx.lineTo(20, 2); ctx.lineTo(15, 4); // Right Eye
            ctx.fill();
            ctx.shadowBlur = 0; // Reset

            // Teeth (Sharp)
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.moveTo(8, 10); ctx.lineTo(9, 15); ctx.lineTo(11, 10);
            ctx.moveTo(11, 10); ctx.lineTo(12, 15); ctx.lineTo(13, 10);
            ctx.moveTo(14, 10); ctx.lineTo(15, 15); ctx.lineTo(16, 10);
            ctx.fill();
            ctx.restore();

            // Legs
            ctx.fillStyle = darkFur;
            // Front Left
            ctx.beginPath(); ctx.moveTo(-10, -5); ctx.lineTo(-15, 10); ctx.lineTo(-5, 10); ctx.fill();
            // Front Right
            ctx.beginPath(); ctx.moveTo(5, -5); ctx.lineTo(0, 10); ctx.lineTo(10, 10); ctx.fill();
            // Back Leg (Haunch)
            ctx.beginPath(); ctx.arc(15, -5, 12, 0, Math.PI); ctx.fill();
            // Back Foot
            ctx.beginPath(); ctx.moveTo(15, 5); ctx.lineTo(10, 10); ctx.lineTo(20, 10); ctx.fill();

            ctx.restore();
        }

        function drawTenTails(ctx, x, y, direction, pose) {
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(direction, 1);

            const scale = 4.0; // Even bigger
            ctx.scale(scale, scale);

            // Colors
            const skinColor = '#d4d4d8'; // Greyish/Wood color
            const eyeColor = '#ef4444'; // Red Rinne-Sharingan

            // Aura
            ctx.shadowColor = '#7f1d1d';
            ctx.shadowBlur = 20;

            // --- Tails (10 of them! - Drawn FIRST to be behind body) ---
            ctx.strokeStyle = skinColor;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            
            for(let i=0; i<10; i++) {
                ctx.beginPath();
                const angle = (i * 0.15) - 0.75;
                const tailX = 10;
                const tailY = -20;
                
                // Waving animation
                const wave = Math.sin(Date.now() / 400 + i) * 5;
                
                ctx.moveTo(tailX, tailY);
                // Hand-like tails
                ctx.bezierCurveTo(
                    tailX + 30, tailY - 40 + (i*5), 
                    tailX + 50 + wave, tailY - 60 + (i*8), 
                    tailX + 70 + wave, tailY - 30 + (i*10) + wave
                );
                ctx.stroke();
                
                // "Hand" at end of tail
                ctx.fillStyle = skinColor;
                ctx.beginPath();
                ctx.arc(tailX + 70 + wave, tailY - 30 + (i*10) + wave, 4, 0, Math.PI*2);
                ctx.fill();
            }

            // Body (Bulbous/Hunchback)
            ctx.fillStyle = skinColor;
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.bezierCurveTo(-20, -40, 20, -40, 0, 0); // Main body shape
            ctx.ellipse(0, -20, 30, 25, 0, 0, Math.PI*2);
            ctx.fill();

            // Head (Single Eye)
            ctx.save();
            ctx.translate(0, -35);
            
            // Eye (Rinnegan/Sharingan)
            ctx.fillStyle = eyeColor;
            ctx.beginPath();
            ctx.arc(0, 0, 8, 0, Math.PI*2);
            ctx.fill();
            
            // Rings (Rinnegan)
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 0.5;
            ctx.beginPath(); ctx.arc(0, 0, 6, 0, Math.PI*2); ctx.stroke();
            ctx.beginPath(); ctx.arc(0, 0, 4, 0, Math.PI*2); ctx.stroke();
            ctx.beginPath(); ctx.arc(0, 0, 2, 0, Math.PI*2); ctx.stroke();
            
            // Tomoe (Sharingan)
            ctx.fillStyle = '#000';
            for(let i=0; i<9; i++) {
                const angle = (i / 9) * Math.PI * 2;
                ctx.beginPath();
                ctx.arc(Math.cos(angle)*5, Math.sin(angle)*5, 1, 0, Math.PI*2);
                ctx.fill();
            }
            
            ctx.restore();

            // Legs (Stumpy)
            ctx.fillStyle = skinColor;
            ctx.beginPath(); ctx.moveTo(-15, -5); ctx.lineTo(-20, 10); ctx.lineTo(-10, 10); ctx.fill();
            ctx.beginPath(); ctx.moveTo(15, -5); ctx.lineTo(10, 10); ctx.lineTo(20, 10); ctx.fill();

            ctx.restore();
        }

        // --- NEW REALISTIC CHARACTER DRAWING ---
        function drawCharacter(player, ctx) {
            if (player.name === 'Nine Tails') {
                drawNineTails(ctx, player.x, player.y, player === gameState.playerA ? 1 : -1, player.pose);
                // Draw Name/HP for Boss
                ctx.fillStyle = 'white'; 
                ctx.font = '20px "Jockey One"'; 
                ctx.textAlign = 'center';
                ctx.fillText("NINE TAILS (BOSS)", player.x, player.y + 20);
                return;
            }
            if (player.name === 'Ten Tails') {
                drawTenTails(ctx, player.x, player.y, player === gameState.playerA ? 1 : -1, player.pose);
                // Draw Name/HP for Boss
                ctx.fillStyle = 'white'; 
                ctx.font = '20px "Jockey One"'; 
                ctx.textAlign = 'center';
                ctx.fillText("TEN TAILS (GOD)", player.x, player.y + 20);
                return;
            }

            const x = player.x;
            const y = player.y; // Feet position
            const isPlayerA = (player === gameState.playerA);
            const direction = isPlayerA ? 1 : -1;
            const isKicking = player.pose === 'kicking';
            const isDefeated = player.pose === 'defeated';

            // Dimensions (Realistic-ish Chibi)
            const headSize = 14;
            const bodyW = 16;
            const bodyH = 28;
            const limbW = 5;
            const limbL = 18;

            // Rotation adjustments for defeated
            let angle = 0;
            let drawX = x;
            let drawY = y;
            
            if (isDefeated) {
                angle = isPlayerA ? -Math.PI / 2 : Math.PI / 2;
                drawY = y - 10; // Lie on ground
            }

            ctx.save();
            ctx.translate(drawX, drawY);
            
            // --- REALISTIC SHADOW ---
            if (!isDefeated) {
                ctx.save();
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.beginPath();
                ctx.ellipse(0, 0, 14, 4, 0, 0, Math.PI * 2);
                ctx.filter = 'blur(2px)';
                ctx.fill();
                ctx.restore();
            }

            ctx.rotate(angle);

            // Center coordinate system at feet: (0, 0)
            // Body is drawn upwards from 0
            
            // Skin Tone
            let skinColor = '#ffdfc4'; // Light peach
            if (player.name === 'Sasuke' && player.isCurseMark) skinColor = '#71717a'; // Grey
            if (player.name === 'Naruto' && player.isThreeTails) skinColor = '#fb923c'; // Orange tint
            if (player.name === 'Rock Lee' && player.isNinthGate) skinColor = '#b91c1c'; // Deep Red
            if (player.name === 'Gaara') skinColor = '#fef3c7'; // Pale
            if (player.name === 'Sakura' && player.is100Healings) skinColor = '#fbcfe8'; // Glowing pinkish skin

            // 3rd Form Skin Colors
            if (player.name === 'Naruto' && player.isSixPaths) skinColor = '#fde047'; // Yellow glowing
            if (player.name === 'Rock Lee' && player.isNightGuy) skinColor = '#7f1d1d'; // Dark Burnt Red
            if (player.name === 'Itachi' && player.isEdoTensei) skinColor = '#9ca3af'; // Grey/Cracked

            // --- Susanoo Avatar (Background) ---
            if ((player.name === 'Itachi' || player.name === 'Madara') && player.isSusanoo) {
                ctx.save();
                ctx.translate(0, -40); // Center around torso
                const sScale = player.name === 'Madara' ? 2.0 : 1.5; // Madara's is bigger
                ctx.scale(sScale * direction, sScale); // Scale up and face direction
                
                // Glow
                const susanooColor = player.name === 'Madara' ? '#3b82f6' : '#f97316'; // Blue vs Orange
                const glowColor = player.name === 'Madara' ? '#60a5fa' : '#ef4444';

                ctx.shadowColor = glowColor;
                ctx.shadowBlur = 20;
                ctx.strokeStyle = susanooColor;
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';
                
                // Ribcage
                for(let i=0; i<4; i++) {
                    ctx.beginPath();
                    ctx.moveTo(0, -10 + (i*12));
                    ctx.bezierCurveTo(30, -10 + (i*12), 40, 10 + (i*12), 10, 20 + (i*12)); // Front ribs
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.moveTo(0, -10 + (i*12));
                    ctx.bezierCurveTo(-30, -10 + (i*12), -40, 10 + (i*12), -10, 20 + (i*12)); // Back ribs
                    ctx.stroke();
                }
                
                // Spine
                ctx.beginPath();
                ctx.moveTo(0, -20);
                ctx.lineTo(0, 60);
                ctx.stroke();
                
                // Head/Skull
                ctx.fillStyle = player.name === 'Madara' ? 'rgba(59, 130, 246, 0.5)' : 'rgba(249, 115, 22, 0.5)';
                ctx.beginPath();
                ctx.moveTo(-15, -20);
                ctx.lineTo(-20, -50); // Horn
                ctx.lineTo(0, -40);
                ctx.lineTo(20, -50); // Horn
                ctx.lineTo(15, -20);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
                
                // Eyes
                ctx.fillStyle = '#fef08a'; // Yellow glow
                ctx.beginPath(); ctx.arc(8, -35, 3, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(-8, -35, 3, 0, Math.PI*2); ctx.fill();
                
                // Arm (Holding Totsuka Blade - simplified)
                ctx.strokeStyle = susanooColor;
                ctx.beginPath();
                ctx.moveTo(20, 0);
                ctx.lineTo(50, 20); // Arm
                ctx.lineTo(80, -10); // Forearm
                ctx.stroke();
                
                // Blade (Spectral)
                ctx.fillStyle = player.name === 'Madara' ? 'rgba(96, 165, 250, 0.6)' : 'rgba(239, 68, 68, 0.6)';
                ctx.beginPath();
                ctx.moveTo(80, -10);
                ctx.lineTo(120, -50);
                ctx.lineTo(130, -40);
                ctx.lineTo(90, 0);
                ctx.fill();

                ctx.restore();
            }

            // --- Wings (Background) ---
            if (player.name === 'Sasuke' && player.isCurseMark) {
                // Draw wings behind body
                drawWings(0, -45, direction); 
            }

            // --- Six Paths Orbs (Background) ---
            if (player.name === 'Naruto' && player.isSixPaths) {
                ctx.fillStyle = '#000';
                for(let i=0; i<6; i++) {
                    const angle = (Date.now() / 1000) + (i * Math.PI / 3);
                    const ox = Math.cos(angle) * 60;
                    const oy = Math.sin(angle) * 60 - 40;
                    ctx.beginPath(); ctx.arc(ox, oy, 8, 0, Math.PI*2); ctx.fill();
                }
            }

            // --- DMS Susanoo Aura (Background) ---
            if (player.name === 'Kakashi' && player.isDMS) {
                ctx.save();
                ctx.shadowColor = '#3b82f6'; ctx.shadowBlur = 30;
                ctx.strokeStyle = 'rgba(59, 130, 246, 0.5)';
                ctx.lineWidth = 5;
                ctx.beginPath();
                ctx.moveTo(0, -100);
                ctx.lineTo(-40, 0);
                ctx.lineTo(40, 0);
                ctx.closePath();
                ctx.stroke();
                ctx.restore();
            }

            // --- Night Guy Aura (Background) ---
            if (player.name === 'Rock Lee' && player.isNightGuy) {
                ctx.save();
                ctx.shadowColor = '#ef4444'; ctx.shadowBlur = 40;
                ctx.fillStyle = 'rgba(185, 28, 28, 0.3)';
                ctx.beginPath();
                ctx.moveTo(0, -20);
                ctx.lineTo(-30, -80); // Dragon shape rough
                ctx.lineTo(30, -60);
                ctx.fill();
                ctx.restore();
            }

            // --- Gold Sand (Background) ---
            if (player.name === 'Gaara' && player.isGoldenSand) {
                ctx.save();
                ctx.fillStyle = '#fcd34d'; // Gold
                for(let i=0; i<10; i++) {
                    const gx = (Math.random() - 0.5) * 80;
                    const gy = (Math.random() - 0.5) * 80 - 40;
                    ctx.beginPath(); ctx.arc(gx, gy, 4, 0, Math.PI*2); ctx.fill();
                }
                ctx.restore();
            }

            // --- Gaara Gourd (Background) ---
            if (player.name === 'Gaara') {
                ctx.save();
                ctx.fillStyle = '#d6d3d1'; // Sand color
                ctx.strokeStyle = '#78350f'; // Brown lines
                ctx.lineWidth = 2;
                
                // Gourd Shape
                ctx.translate(-10 * direction, -40);
                ctx.rotate(-0.2 * direction);
                
                ctx.beginPath();
                ctx.ellipse(0, 0, 18, 25, 0, 0, Math.PI*2); // Bottom part
                ctx.fill(); ctx.stroke();
                
                ctx.beginPath();
                ctx.ellipse(0, -25, 12, 15, 0, 0, Math.PI*2); // Top part
                ctx.fill(); ctx.stroke();
                
                // Rope
                ctx.fillStyle = '#b91c1c';
                ctx.fillRect(-5, -15, 10, 4);
                
                // Sand Texture
                ctx.fillStyle = '#a8a29e';
                for(let i=0; i<5; i++) {
                    ctx.beginPath();
                    ctx.arc((Math.random()-0.5)*20, (Math.random()-0.5)*40, 1, 0, Math.PI*2);
                    ctx.fill();
                }
                
                ctx.restore();
            }
            
            // --- Three Tails (Background) ---
            if (player.name === 'Naruto' && player.isThreeTails) {
                // Draw three tails behind body
                drawThreeTails(0, -20, direction);
            }
            
            // --- Shukaku Tail (Background) ---
            if (player.name === 'Gaara' && player.isShukaku) {
                // Big sand tail
                ctx.save();
                ctx.fillStyle = '#d6d3d1';
                ctx.strokeStyle = '#a8a29e';
                ctx.lineWidth = 2;
                
                ctx.beginPath();
                ctx.moveTo(0, -20);
                // Draw a big thick tail
                ctx.bezierCurveTo(-40 * direction, -10, -60 * direction, -50, -80 * direction, -30);
                ctx.bezierCurveTo(-60 * direction, -10, -40 * direction, 10, 0, 0);
                ctx.fill();
                ctx.stroke();
                
                // Blue markings
                ctx.strokeStyle = '#1e3a8a';
                ctx.beginPath();
                ctx.moveTo(-20 * direction, -15); ctx.lineTo(-20 * direction, -5);
                ctx.moveTo(-40 * direction, -25); ctx.lineTo(-40 * direction, -15);
                ctx.stroke();
                
                ctx.restore();
            }
            
            // --- 9th Gate Aura (Background) ---
            if (player.name === 'Rock Lee' && player.isNinthGate) {
                ctx.save();
                ctx.fillStyle = 'rgba(220, 38, 38, 0.4)'; // Red aura
                ctx.shadowColor = '#ef4444';
                ctx.shadowBlur = 20;
                ctx.beginPath();
                ctx.arc(0, -30, 45, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }

            // --- Legs ---
            // Leg Colors
            let legColor = '#e5e7eb'; // Default
            if (player.name === 'Naruto') legColor = '#f97316'; // Orange pants
            else if (player.name === 'Sasuke') legColor = '#1f2937'; // Dark Blue/Black pants (Shippuden)
            else if (player.name === 'Rock Lee') legColor = '#16a34a'; // Green jumpsuit
            else if (player.name === 'Gaara') legColor = '#7f1d1d'; // Dark Red pants
            else if (player.name === 'Sakura') legColor = '#374151'; // Grey skirt/shorts
            else if (player.name === 'Kakashi') legColor = '#1f2937'; // Dark Blue/Black pants
            else if (player.name === 'Hinata') legColor = '#1f2937'; // Dark pants
            else if (player.name === 'Itachi') legColor = '#1f2937'; // Dark pants
            else if (player.name === 'Madara') legColor = '#1f2937'; // Dark pants
            else if (player.name === 'Minato') legColor = '#1f2937'; // Dark pants
            else if (player.name === 'Obito') legColor = '#1f2937'; // Dark pants
            else if (player.name === 'Pain') legColor = '#1f2937'; // Dark pants

            ctx.fillStyle = legColor;
            ctx.strokeStyle = '#1f2937';
            ctx.lineWidth = 1;

            // Leg positions
            let leg1Rot = 0; 
            let leg2Rot = 0;
            
            if (isKicking) {
                // Front leg up
                leg1Rot = -Math.PI / 3 * direction; // Kick up
                leg2Rot = Math.PI / 6 * direction; // Back leg stance
            }

            // Draw Leg 2 (Back)
            ctx.save();
            ctx.translate(-4 * direction, -limbL); // Hip joint
            ctx.rotate(leg2Rot);
            ctx.fillStyle = legColor;
            if(player.name === 'Rock Lee') {
                 // Orange Leg Warmers
                 ctx.fillStyle = '#f97316';
                 ctx.fillRect(-limbW/2, 0, limbW, limbL); // Lower leg
                 ctx.fillStyle = '#16a34a';
                 ctx.fillRect(-limbW/2, -5, limbW, 10); // Upper leg part
            } else if (player.name === 'Sasuke') {
                // Dark pants, maybe apron flap
                ctx.fillStyle = '#1f2937';
                ctx.fillRect(-limbW/2, 0, limbW, limbL);
            } else {
                ctx.fillRect(-limbW/2, 0, limbW, limbL);
            }
            // Sandals
            ctx.fillStyle = '#1f2937';
            ctx.fillRect(-limbW/2 - 2*direction, limbL-2, limbW+4, 4);
            ctx.restore();

            // Draw Leg 1 (Front)
            ctx.save();
            ctx.translate(4 * direction, -limbL); // Hip joint
            ctx.rotate(leg1Rot);
            ctx.fillStyle = legColor;
             if(player.name === 'Rock Lee') {
                 ctx.fillStyle = '#f97316';
                 ctx.fillRect(-limbW/2, 0, limbW, limbL);
                 ctx.fillStyle = '#16a34a';
                 ctx.fillRect(-limbW/2, -5, limbW, 10);
            } else {
                ctx.fillRect(-limbW/2, 0, limbW, limbL);
            }
            // Sandals
            ctx.fillStyle = '#1f2937';
            ctx.fillRect(-limbW/2 - 2*direction, limbL-2, limbW+4, 4);
            ctx.restore();


            // --- Body/Torso ---
            let bodyColor = '#f97316';
            if (player.name === 'Sasuke') bodyColor = '#e5e7eb'; // White Shirt (Shippuden)
            if (player.name === 'Rock Lee') bodyColor = '#16a34a'; // Green
            if (player.name === 'Gaara') bodyColor = '#7f1d1d'; // Dark Red
            if (player.name === 'Sakura') bodyColor = '#be123c'; // Red/Pink top
            if (player.name === 'Kakashi') bodyColor = '#1f2937'; // Dark Blue shirt under vest
            if (player.name === 'Hinata') bodyColor = '#e9d5ff'; // Lavender/Cream hoodie
            if (player.name === 'Itachi') bodyColor = '#000000'; // Akatsuki Cloak
            if (player.name === 'Madara') bodyColor = '#7f1d1d'; // Red Armor
            if (player.name === 'Minato') bodyColor = '#15803d'; // Green Vest (Standard Jonin)
            if (player.name === 'Obito') bodyColor = '#312e81'; // Indigo Robe
            if (player.name === 'Pain') bodyColor = '#000000'; // Akatsuki Cloak

            ctx.fillStyle = bodyColor;
            // Torso Rect
            ctx.fillRect(-bodyW/2, -bodyH - limbL, bodyW, bodyH);
            
            // Vest / Details
            if (player.name === 'Naruto') {
                // Black shoulders/top
                ctx.fillStyle = '#000';
                ctx.fillRect(-bodyW/2, -bodyH - limbL, bodyW, 10);
                // Zipper
                ctx.fillStyle = '#000';
                ctx.fillRect(-1, -bodyH - limbL, 2, bodyH);
                // Spiral crest (simplified)
                ctx.fillStyle = '#ef4444';
                ctx.beginPath(); ctx.arc(0, -bodyH - limbL + 14, 4, 0, Math.PI*2); ctx.fill();
                // Mesh under shirt (neck)
                ctx.fillStyle = '#374151';
                ctx.beginPath(); ctx.moveTo(-4, -bodyH - limbL); ctx.lineTo(4, -bodyH - limbL); ctx.lineTo(0, -bodyH - limbL + 4); ctx.fill();
            }
            else if (player.name === 'Sasuke') {
                // Open chest
                ctx.fillStyle = skinColor;
                ctx.beginPath();
                ctx.moveTo(-2, -bodyH - limbL);
                ctx.lineTo(2, -bodyH - limbL);
                ctx.lineTo(0, -bodyH - limbL + 10);
                ctx.fill();
                // Purple Rope Belt
                ctx.fillStyle = '#a855f7';
                ctx.fillRect(-bodyW/2 - 2, -limbL - 6, bodyW + 4, 6);
                // Knot
                ctx.beginPath(); ctx.arc(4 * direction, -limbL - 3, 4, 0, Math.PI*2); ctx.fill();
            }
            else if (player.name === 'Rock Lee') {
                 // Red Belt
                 ctx.fillStyle = '#ef4444';
                 ctx.fillRect(-bodyW/2, -limbL - 4, bodyW, 4);
            }
            else if (player.name === 'Gaara') {
                // Long Coat
                ctx.fillStyle = '#7f1d1d';
                ctx.fillRect(-bodyW/2 - 1, -bodyH - limbL, bodyW + 2, bodyH + 5); // Longer
                // Sash
                ctx.fillStyle = '#d1d5db'; // Grey sash
                ctx.beginPath();
                ctx.moveTo(-bodyW/2, -bodyH - limbL);
                ctx.lineTo(bodyW/2, -limbL);
                ctx.lineTo(bodyW/2, -limbL - 5);
                ctx.lineTo(-bodyW/2, -bodyH - limbL - 5);
                ctx.fill();
                
                if (player.isShukaku) {
                    // Sand covering half torso
                    ctx.fillStyle = '#d6d3d1';
                    ctx.fillRect(0, -bodyH - limbL, bodyW/2, bodyH); // Cover right half
                }
            }
            else if (player.name === 'Kakashi') {
                // Flak Jacket (Green)
                ctx.fillStyle = '#15803d'; // Green
                ctx.fillRect(-bodyW/2 - 1, -bodyH - limbL, bodyW + 2, bodyH - 5);
                
                // Zipper line
                ctx.fillStyle = '#1f2937';
                ctx.fillRect(-1, -bodyH - limbL, 2, bodyH - 5);
                
                // Pockets
                ctx.fillStyle = '#166534';
                ctx.fillRect(-bodyW/2 + 2, -bodyH - limbL + 5, 4, 6);
                ctx.fillRect(bodyW/2 - 6, -bodyH - limbL + 5, 4, 6);
                
                // Red swirl on back (if we could see it, but front view)
                // Collar
                ctx.fillStyle = '#15803d';
                ctx.fillRect(-bodyW/2, -bodyH - limbL - 4, bodyW, 4);
            }
            else if (player.name === 'Hinata') {
                // Hoodie details (Shippuden Jacket)
                ctx.fillStyle = '#e9d5ff'; // Lavender/Cream
                ctx.fillRect(-bodyW/2, -bodyH - limbL, bodyW, bodyH); 
                
                // Zipper
                ctx.fillStyle = '#d8b4fe';
                ctx.fillRect(-1, -bodyH - limbL, 2, bodyH);
            }
            else if (player.name === 'Itachi') {
                // Akatsuki Clouds (Red)
                ctx.fillStyle = '#ef4444';
                // Cloud 1
                ctx.beginPath(); ctx.arc(-5, -bodyH - limbL + 10, 3, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(-2, -bodyH - limbL + 8, 3, 0, Math.PI*2); ctx.fill();
                // Cloud 2
                ctx.beginPath(); ctx.arc(5, -bodyH - limbL + 20, 3, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(2, -bodyH - limbL + 22, 3, 0, Math.PI*2); ctx.fill();
                
                // Collar
                ctx.fillStyle = '#000';
                ctx.fillRect(-bodyW/2, -bodyH - limbL - 5, bodyW, 5);
                ctx.strokeStyle = '#ef4444'; // Red lining
                ctx.lineWidth = 1;
                ctx.strokeRect(-bodyW/2, -bodyH - limbL - 5, bodyW, 5);
            }
            else if (player.name === 'Madara') {
                // Samurai Armor Plates
                ctx.fillStyle = '#991b1b'; // Darker Red
                // Chest plate
                ctx.fillRect(-bodyW/2, -bodyH - limbL, bodyW, 15);
                // Stomach plates
                ctx.fillStyle = '#7f1d1d';
                for(let i=0; i<3; i++) {
                    ctx.fillRect(-bodyW/2 + 2, -bodyH - limbL + 16 + (i*4), bodyW - 4, 3);
                }
                // Shoulder pads (sticking out)
                ctx.fillStyle = '#991b1b';
                ctx.beginPath();
                ctx.moveTo(-bodyW/2, -bodyH - limbL);
                ctx.lineTo(-bodyW/2 - 8, -bodyH - limbL + 5);
                ctx.lineTo(-bodyW/2, -bodyH - limbL + 10);
                ctx.fill();
                ctx.beginPath();
                ctx.moveTo(bodyW/2, -bodyH - limbL);
                ctx.lineTo(bodyW/2 + 8, -bodyH - limbL + 5);
                ctx.lineTo(bodyW/2, -bodyH - limbL + 10);
                ctx.fill();
            }
            else if (player.name === 'Minato') {
                // Flak Jacket (Green)
                ctx.fillStyle = '#15803d'; 
                ctx.fillRect(-bodyW/2 - 1, -bodyH - limbL, bodyW + 2, bodyH - 5);
                // Zipper
                ctx.fillStyle = '#1f2937';
                ctx.fillRect(-1, -bodyH - limbL, 2, bodyH - 5);
                // Pockets
                ctx.fillStyle = '#166534';
                ctx.fillRect(-bodyW/2 + 2, -bodyH - limbL + 5, 4, 6);
                ctx.fillRect(bodyW/2 - 6, -bodyH - limbL + 5, 4, 6);
                // White Cloak (Back) - drawn behind? No, let's draw it as a cape
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.moveTo(-bodyW/2, -bodyH - limbL);
                ctx.lineTo(-bodyW/2 - 5, -limbL + 5); // Flare out
                ctx.lineTo(bodyW/2 + 5, -limbL + 5);
                ctx.lineTo(bodyW/2, -bodyH - limbL);
                ctx.fill();
                // Flames on bottom
                ctx.fillStyle = '#ef4444';
                ctx.beginPath();
                ctx.moveTo(-bodyW/2 - 5, -limbL + 5);
                ctx.lineTo(-bodyW/2, -limbL);
                ctx.lineTo(-bodyW/2 + 5, -limbL + 5);
                ctx.lineTo(0, -limbL);
                ctx.lineTo(bodyW/2 - 5, -limbL + 5);
                ctx.lineTo(bodyW/2, -limbL);
                ctx.lineTo(bodyW/2 + 5, -limbL + 5);
                ctx.fill();
                // Redraw Vest over cloak
                ctx.fillStyle = '#15803d'; 
                ctx.fillRect(-bodyW/2 - 1, -bodyH - limbL, bodyW + 2, bodyH - 5);
                ctx.fillStyle = '#1f2937';
                ctx.fillRect(-1, -bodyH - limbL, 2, bodyH - 5);
            }
            else if (player.name === 'Obito') {
                // Long Robe
                ctx.fillStyle = '#312e81'; // Indigo
                ctx.fillRect(-bodyW/2 - 1, -bodyH - limbL, bodyW + 2, bodyH + 5);
                // Collar
                ctx.fillStyle = '#312e81';
                ctx.beginPath();
                ctx.moveTo(-bodyW/2, -bodyH - limbL);
                ctx.lineTo(-bodyW/2 - 5, -bodyH - limbL - 5);
                ctx.lineTo(bodyW/2 + 5, -bodyH - limbL - 5);
                ctx.lineTo(bodyW/2, -bodyH - limbL);
                ctx.fill();
                // Belt/Sash
                ctx.fillStyle = '#1f2937'; // Dark sash
                ctx.fillRect(-bodyW/2 - 1, -limbL - 10, bodyW + 2, 5);
            }
            else if (player.name === 'Pain') {
                // Akatsuki Cloak (Same as Itachi)
                ctx.fillStyle = '#ef4444';
                // Cloud 1
                ctx.beginPath(); ctx.arc(-5, -bodyH - limbL + 10, 3, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(-2, -bodyH - limbL + 8, 3, 0, Math.PI*2); ctx.fill();
                // Cloud 2
                ctx.beginPath(); ctx.arc(5, -bodyH - limbL + 20, 3, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(2, -bodyH - limbL + 22, 3, 0, Math.PI*2); ctx.fill();
                
                // Collar
                ctx.fillStyle = '#000';
                ctx.fillRect(-bodyW/2, -bodyH - limbL - 5, bodyW, 5);
                ctx.strokeStyle = '#ef4444'; // Red lining
                ctx.lineWidth = 1;
                ctx.strokeRect(-bodyW/2, -bodyH - limbL - 5, bodyW, 5);
            }


            // --- Head ---
            const neckY = -bodyH - limbL;
            ctx.translate(0, neckY);
            
            // Skin Circle
            ctx.fillStyle = skinColor;
            ctx.beginPath();
            ctx.arc(0, -headSize, headSize, 0, Math.PI*2);
            ctx.fill();

            // Face (Eyes) - Simple dots
            ctx.fillStyle = '#000';
            
            // Special Eyes
            if (player.name === 'Sasuke' && player.isRinnegan) {
                ctx.fillStyle = '#a855f7'; // Purple
            } else if (player.name === 'Hinata' && player.isTenseigan) {
                ctx.fillStyle = '#22d3ee'; // Cyan
                ctx.shadowColor = '#22d3ee'; ctx.shadowBlur = 5;
            } else if (player.name === 'Itachi' && player.isEdoTensei) {
                // Black Sclera
                ctx.fillStyle = '#000';
                ctx.beginPath(); ctx.arc(4 * direction, -headSize - 1, 3, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#fff'; // White pupil (Edo Tensei usually has dark sclera, light pupil)
            }

            ctx.beginPath();
            ctx.arc(4 * direction, -headSize - 1, 1.5, 0, Math.PI*2); // Front eye
            ctx.fill();
            ctx.shadowBlur = 0;
            
            // Three-tails form: glowing red eyes
            if (player.name === 'Naruto' && player.isThreeTails) {
                ctx.fillStyle = '#dc2626';
                ctx.shadowColor = '#ef4444';
                ctx.shadowBlur = 5;
                ctx.beginPath();
                ctx.arc(4 * direction, -headSize - 1, 2, 0, Math.PI*2);
                ctx.fill();
                ctx.shadowBlur = 0;
            }

            // Headband
            if (player.name !== 'Rock Lee' && player.name !== 'Gaara' && player.name !== 'Sakura' && player.name !== 'Kakashi' && player.name !== 'Hinata' && player.name !== 'Itachi' && player.name !== 'Obito') { // Lee wears it on waist, Gaara doesn't wear one usually or on gourd, Sakura wears it as hairband
                ctx.fillStyle = '#1f2937'; // Navy band
                ctx.fillRect(-headSize - 2, -headSize - 10, headSize*2 + 4, 6);
                ctx.fillStyle = '#d1d5db'; // Metal plate
                ctx.fillRect(-6, -headSize - 9, 12, 4);
                
                // Ties (Naruto)
                if (player.name === 'Naruto') {
                    ctx.fillStyle = '#1f2937';
                    ctx.beginPath();
                    ctx.moveTo(-headSize, -headSize - 5);
                    ctx.quadraticCurveTo(-headSize - 10, -headSize, -headSize - 15, -headSize + 5);
                    ctx.lineTo(-headSize - 12, -headSize + 5);
                    ctx.quadraticCurveTo(-headSize - 8, -headSize, -headSize, -headSize - 8);
                    ctx.fill();
                }
            } else if (player.name === 'Kakashi') {
                // Headband angled over left eye
                ctx.fillStyle = '#1f2937'; // Navy band
                ctx.save();
                ctx.rotate(0.1 * direction); // Slight tilt
                ctx.fillRect(-headSize - 2, -headSize - 10, headSize*2 + 4, 8); // Thicker to cover eye
                
                // Metal plate
                ctx.fillStyle = '#d1d5db';
                ctx.fillRect(-6, -headSize - 9, 12, 4);
                ctx.restore();
            } else if (player.name === 'Hinata') {
                // Headband around neck
                ctx.fillStyle = '#1f2937'; // Navy band
                ctx.fillRect(-headSize + 2, -headSize + 12, headSize*2 - 4, 4);
                ctx.fillStyle = '#d1d5db'; // Metal plate
                ctx.fillRect(-4, -headSize + 12, 8, 3);
            } else if (player.name === 'Itachi') {
                // Headband with scratch
                ctx.fillStyle = '#1f2937'; // Navy band
                ctx.fillRect(-headSize - 2, -headSize - 10, headSize*2 + 4, 6);
                ctx.fillStyle = '#d1d5db'; // Metal plate
                ctx.fillRect(-6, -headSize - 9, 12, 4);
                // Scratch
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(-4, -headSize - 7); ctx.lineTo(4, -headSize - 7); ctx.stroke();
            }

            // --- Hair ---
            ctx.fillStyle = '#fcd34d'; // Blonde default
            
            if (player.name === 'Naruto') {
                ctx.fillStyle = player.isThreeTails ? '#dc2626' : '#facc15'; // Red in three-tails form, yellow normal
                ctx.beginPath();
                // Spikes
                ctx.moveTo(-headSize, -headSize - 8);
                for(let i=0; i<5; i++) {
                    ctx.lineTo(-headSize + (i*6), -headSize - 18);
                    ctx.lineTo(-headSize + (i*6) + 3, -headSize - 8);
                }
                ctx.fill();
                
                // Add whisker marks (more pronounced in three-tails form)
                ctx.strokeStyle = player.isThreeTails ? '#dc2626' : '#1f2937';
                ctx.lineWidth = player.isThreeTails ? 2 : 1;
                for(let w = 0; w < 3; w++) {
                    ctx.beginPath();
                    ctx.moveTo(3 * direction, -headSize + 2 + (w * 3));
                    ctx.lineTo(10 * direction, -headSize + (w * 3));
                    ctx.stroke();
                }
            } 
            else if (player.name === 'Sasuke') {
                ctx.fillStyle = player.isCurseMark ? '#374151' : '#111827'; // Greyish blue or Black
                
                ctx.beginPath();
                // Design for facing RIGHT (direction = 1)
                // Multiply all X by direction to flip correctly
                
                // Start Top Center
                ctx.moveTo(2 * direction, -headSize - 18);
                
                // --- Front Bangs (Face Side) ---
                // Forehead
                ctx.lineTo(10 * direction, -headSize - 10);
                // Main Long Bang (Frames face)
                ctx.lineTo(15 * direction, -headSize + 8); 
                // Cheek/Sideburn area
                ctx.lineTo(12 * direction, -headSize - 2);
                ctx.lineTo(14 * direction, -headSize + 2); // Sideburn tip
                
                // --- Bottom/Nape ---
                ctx.lineTo(6 * direction, -headSize + 5); // Behind ear
                ctx.lineTo(-4 * direction, -headSize + 10); // Nape
                
                // --- Back Spikes (The "Duckbutt") ---
                // Lowest Spike
                ctx.lineTo(-16 * direction, -headSize + 15); 
                ctx.lineTo(-10 * direction, -headSize + 2); // Valley
                
                // Middle Spike (Big)
                ctx.lineTo(-24 * direction, -headSize - 5);
                ctx.lineTo(-12 * direction, -headSize - 12); // Valley
                
                // Top Spike (High)
                ctx.lineTo(-20 * direction, -headSize - 25);
                ctx.lineTo(-5 * direction, -headSize - 20); // Top of head
                
                ctx.closePath();
                ctx.fill();
            }
            else if (player.name === 'Rock Lee') {
                ctx.fillStyle = '#000'; // Black
                ctx.beginPath();
                // Bowl cut
                ctx.arc(0, -headSize - 2, headSize + 1, Math.PI, 0);
                ctx.lineTo(headSize + 1, -headSize + 5);
                ctx.lineTo(-headSize - 1, -headSize + 5);
                ctx.fill();
                // Shine
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.fillRect(-8, -headSize - 10, 4, 4);
            }
            else if (player.name === 'Gaara') {
                ctx.fillStyle = '#991b1b'; // Red hair
                ctx.beginPath();
                // Spiky short hair
                ctx.moveTo(-headSize, -headSize);
                for(let i=0; i<6; i++) {
                    ctx.lineTo(-headSize + (i*5), -headSize - 10);
                    ctx.lineTo(-headSize + (i*5) + 2, -headSize);
                }
                ctx.fill();
                
                // If Shukaku, draw sand mask on one side
                if (player.isShukaku) {
                    ctx.fillStyle = '#d6d3d1'; // Sand color
                    ctx.beginPath();
                    // Draw a shape covering the right half of the face (relative to character)
                    ctx.arc(0, -headSize, headSize + 1, -Math.PI/2, Math.PI/2, false); 
                    ctx.fill();
                    
                    // Blue markings on sand
                    ctx.strokeStyle = '#1e3a8a'; // Blue
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(0, -headSize);
                    ctx.lineTo(headSize, -headSize - 5);
                    ctx.stroke();
                }

                // Eye rings
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 1;
                
                if (player.isShukaku) {
                    // Draw Shukaku Eye (Yellow with black pupil)
                    ctx.fillStyle = '#facc15'; // Yellow
                    ctx.beginPath();
                    ctx.arc(4 * direction, -headSize - 1, 4, 0, Math.PI*2);
                    ctx.fill();
                    
                    // Pupil (Star/Cross shape)
                    ctx.fillStyle = '#000';
                    ctx.beginPath();
                    ctx.arc(4 * direction, -headSize - 1, 1.5, 0, Math.PI*2);
                    ctx.fill();
                } else {
                    // Normal Eye
                    ctx.beginPath();
                    ctx.arc(4 * direction, -headSize - 1, 3, 0, Math.PI*2);
                    ctx.stroke();
                }
            }
            else if (player.name === 'Sakura') {
                ctx.fillStyle = '#f472b6'; // Pink hair
                ctx.beginPath();
                // Bob cut
                ctx.moveTo(-headSize, -headSize - 5);
                ctx.lineTo(-headSize - 2, -headSize + 5); // Left side
                ctx.lineTo(headSize + 2, -headSize + 5); // Right side
                ctx.lineTo(headSize, -headSize - 5);
                ctx.arc(0, -headSize - 5, headSize, Math.PI, 0); // Top
                ctx.fill();
                
                // Headband (Red)
                ctx.fillStyle = '#be123c';
                ctx.fillRect(-headSize, -headSize - 12, headSize*2, 4);
                
                // 100 Healings Mark
                if (player.is100Healings) {
                    ctx.fillStyle = '#6d28d9'; // Purple diamond
                    ctx.beginPath();
                    ctx.moveTo(0, -headSize - 4);
                    ctx.lineTo(3, -headSize);
                    ctx.lineTo(0, -headSize + 4);
                    ctx.lineTo(-3, -headSize);
                    ctx.fill();
                    
                    // Lines
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(0, -headSize); ctx.lineTo(0, -headSize + 10); // Down nose
                    ctx.moveTo(0, -headSize); ctx.lineTo(6, -headSize - 6); // Up right
                    ctx.moveTo(0, -headSize); ctx.lineTo(-6, -headSize - 6); // Up left
                    ctx.stroke();
                }
            }
            else if (player.name === 'Kakashi') {
                // Mask
                ctx.fillStyle = '#1f2937'; // Dark Blue mask
                ctx.beginPath();
                ctx.moveTo(-headSize, -headSize/2);
                ctx.lineTo(headSize, -headSize/2);
                ctx.lineTo(headSize, headSize); // Chin
                ctx.arc(0, 0, headSize, 0, Math.PI, false);
                ctx.lineTo(-headSize, -headSize/2);
                ctx.fill();

                // Hair (Silver/White)
                ctx.fillStyle = '#e5e7eb'; // Silver
                ctx.beginPath();
                // Spiky to the left
                ctx.moveTo(headSize, -headSize - 5);
                ctx.lineTo(0, -headSize - 15); // Top spike
                ctx.lineTo(-headSize - 5, -headSize - 10); // Left spike
                ctx.lineTo(-headSize - 2, -headSize);
                ctx.lineTo(headSize, -headSize - 5);
                ctx.fill();
                
                // Eye (Right eye visible)
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(4 * direction, -headSize - 2, 1.5, 0, Math.PI*2);
                ctx.fill();
                
                // Scar over left eye (covered by headband usually, but if transformed...)
                if (player.isMangekyou) {
                    // Lift headband
                    // Draw Sharingan Eye
                    ctx.fillStyle = '#dc2626'; // Red
                    ctx.beginPath();
                    ctx.arc(-4 * direction, -headSize - 2, 2, 0, Math.PI*2);
                    ctx.fill();
                    
                    // Scar
                    ctx.strokeStyle = '#7f1d1d';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(-4 * direction, -headSize - 8);
                    ctx.lineTo(-4 * direction, -headSize + 4);
                    ctx.stroke();
                }
            }
            else if (player.name === 'Hinata') {
                ctx.fillStyle = '#312e81'; // Indigo hair
                ctx.beginPath();
                // Hime cut
                ctx.moveTo(-headSize, -headSize - 5);
                ctx.lineTo(-headSize - 2, -headSize + 8); // Long side
                ctx.lineTo(-headSize + 4, -headSize - 2); // Bangs
                ctx.lineTo(headSize - 4, -headSize - 2); // Bangs
                ctx.lineTo(headSize + 2, -headSize + 8); // Long side
                ctx.lineTo(headSize, -headSize - 5);
                ctx.arc(0, -headSize - 5, headSize, Math.PI, 0); // Top
                ctx.fill();
                
                // Byakugan Eyes
                ctx.fillStyle = '#e9d5ff'; // Lavender white
                ctx.beginPath();
                ctx.arc(4 * direction, -headSize - 1, 2.5, 0, Math.PI*2);
                ctx.fill();
                
                // Veins if awakened
                if (player.isTwinLion) {
                    ctx.strokeStyle = '#d8b4fe';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(6 * direction, -headSize - 1);
                    ctx.lineTo(10 * direction, -headSize - 3);
                    ctx.moveTo(6 * direction, -headSize - 1);
                    ctx.lineTo(10 * direction, -headSize + 1);
                    ctx.stroke();
                }
            }
            else if (player.name === 'Itachi') {
                ctx.fillStyle = '#000'; // Black hair
                ctx.beginPath();
                // Long hair
                ctx.moveTo(-headSize, -headSize - 5);
                ctx.lineTo(-headSize - 2, -headSize + 10);
                ctx.lineTo(headSize + 2, -headSize + 10);
                ctx.lineTo(headSize, -headSize - 5);
                ctx.arc(0, -headSize - 5, headSize, Math.PI, 0);
                ctx.fill();
                
                // Sharingan Eyes
                ctx.fillStyle = '#dc2626'; // Red
                ctx.beginPath();
                ctx.arc(4 * direction, -headSize - 1, 2, 0, Math.PI*2);
                ctx.fill();
                
                // Lines under eyes
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 0.5;
                ctx.beginPath();
                ctx.moveTo(2 * direction, -headSize + 1); ctx.lineTo(0, -headSize + 6);
                ctx.moveTo(6 * direction, -headSize + 1); ctx.lineTo(8 * direction, -headSize + 6);
                ctx.stroke();
            }
            else if (player.name === 'Madara') {
                ctx.fillStyle = '#000'; // Black hair
                ctx.beginPath();
                // Very Long Spiky Hair
                ctx.moveTo(0, -headSize - 15); // Top
                // Right side spikes (Back)
                ctx.lineTo(-headSize - 10, -headSize - 5);
                ctx.lineTo(-headSize - 20, -headSize + 10);
                ctx.lineTo(-headSize - 15, -headSize + 25); // Longest point
                ctx.lineTo(-headSize - 5, -headSize + 15);
                // Left side (Front/Face)
                ctx.lineTo(headSize + 5, -headSize + 15); // Bangs covering side
                ctx.lineTo(headSize, -headSize - 5);
                ctx.fill();
                
                // Rinnegan Eye (Purple with rings)
                ctx.fillStyle = '#c084fc'; // Purple
                ctx.beginPath();
                ctx.arc(4 * direction, -headSize - 1, 2.5, 0, Math.PI*2);
                ctx.fill();
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 0.5;
                ctx.beginPath(); ctx.arc(4 * direction, -headSize - 1, 1.5, 0, Math.PI*2); ctx.stroke();
            }
            else if (player.name === 'Minato') {
                ctx.fillStyle = '#facc15'; // Yellow
                ctx.beginPath();
                // Spikes
                ctx.moveTo(-headSize, -headSize - 8);
                for(let i=0; i<5; i++) {
                    ctx.lineTo(-headSize + (i*6), -headSize - 18);
                    ctx.lineTo(-headSize + (i*6) + 3, -headSize - 8);
                }
                // Long side bangs
                ctx.moveTo(-headSize, -headSize - 5);
                ctx.lineTo(-headSize - 5, -headSize + 10); // Left
                ctx.lineTo(-headSize + 2, -headSize);
                
                ctx.moveTo(headSize, -headSize - 5);
                ctx.lineTo(headSize + 5, -headSize + 10); // Right
                ctx.lineTo(headSize - 2, -headSize);
                ctx.fill();

                if (player.isSageMode) {
                    // Sage Mode Eyes (Orange pigmentation)
                    ctx.fillStyle = '#f97316'; // Orange
                    ctx.beginPath();
                    ctx.arc(4 * direction, -headSize - 1, 4, 0, Math.PI*2); // Eye shadow
                    ctx.fill();
                    
                    // Pupil (Horizontal bar for Toad Sage)
                    ctx.fillStyle = '#000';
                    ctx.fillRect((4 * direction) - 2, -headSize - 1.5, 4, 1);
                }
            }
            else if (player.name === 'Obito') {
                // White Mask
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(0, -headSize, headSize + 1, 0, Math.PI*2);
                ctx.fill();
                // Eye Holes / Pattern
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 1;
                ctx.beginPath();
                // Spiral pattern
                for(let r=2; r<headSize; r+=3) {
                    ctx.arc(0, -headSize, r, 0, Math.PI*2);
                }
                ctx.stroke();
                // Eye Holes
                ctx.fillStyle = '#000';
                ctx.beginPath(); ctx.arc(4 * direction, -headSize - 2, 2, 0, Math.PI*2); ctx.fill(); // Right eye (Sharingan/Rinnegan)
                
                // Rinnegan/Sharingan visible?
                ctx.fillStyle = '#a855f7'; // Purple
                ctx.beginPath(); ctx.arc(4 * direction, -headSize - 2, 1.5, 0, Math.PI*2); ctx.fill();
            }
            else if (player.name === 'Pain') {
                ctx.fillStyle = '#f97316'; // Orange hair
                ctx.beginPath();
                // Spiky
                ctx.moveTo(-headSize, -headSize - 5);
                for(let i=0; i<6; i++) {
                    ctx.lineTo(-headSize + (i*5), -headSize - 15);
                    ctx.lineTo(-headSize + (i*5) + 2, -headSize - 5);
                }
                ctx.fill();
                
                // Rinnegan Eyes
                ctx.fillStyle = '#a855f7'; // Purple
                ctx.beginPath(); ctx.arc(4 * direction, -headSize - 1, 2.5, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = '#000'; ctx.lineWidth = 0.5;
                ctx.beginPath(); ctx.arc(4 * direction, -headSize - 1, 1.5, 0, Math.PI*2); ctx.stroke();
                
                // Piercings (Black dots)
                ctx.fillStyle = '#000';
                ctx.beginPath(); ctx.arc(0, -headSize + 2, 1, 0, Math.PI*2); ctx.fill(); // Nose
                ctx.beginPath(); ctx.arc(-5, -headSize + 5, 1, 0, Math.PI*2); ctx.fill(); // Cheek
                ctx.beginPath(); ctx.arc(5, -headSize + 5, 1, 0, Math.PI*2); ctx.fill(); // Cheek
            }


            // --- Arms ---
            // Reset to Neck
            // Draw Arm (Simple swinging rect)
            let armRot = isKicking ? -Math.PI/4 * direction : 0;
            if (player.pose === 'kicking') armRot = Math.PI/2 * direction; // Punch/Balance
            
            ctx.fillStyle = bodyColor; 
            if(player.name === 'Sasuke') {
                // Skin color arms (sleeveless)
                ctx.fillStyle = skinColor; 
            }
            else if (player.name === 'Rock Lee') ctx.fillStyle = '#16a34a';
            else if (player.name === 'Gaara') ctx.fillStyle = '#7f1d1d';
            else if (player.name === 'Sakura') ctx.fillStyle = skinColor; // Sleeveless
            else if (player.name === 'Kakashi') ctx.fillStyle = '#1f2937'; // Dark blue sleeves
            else if (player.name === 'Hinata') ctx.fillStyle = '#e9d5ff'; // Lavender sleeves
            else if (player.name === 'Itachi') ctx.fillStyle = '#000000'; // Black sleeves
            else if (player.name === 'Madara') ctx.fillStyle = '#7f1d1d'; // Red sleeves

            ctx.save();
            ctx.translate(0, 0); // Shoulder
            ctx.rotate(armRot);
            ctx.fillRect(-2, 0, 4, 16); // Arm
            
            // Wristbands / Details
            if (player.name === 'Sasuke') {
                // Wristbands
                ctx.fillStyle = '#1f2937';
                ctx.fillRect(-2, 10, 4, 4);
            }
            
            // Hand
            ctx.fillStyle = skinColor;
            if (player.name === 'Sakura') ctx.fillStyle = '#1f2937'; // Black gloves
            
            // Shukaku Arm (Transformation)
            if (player.name === 'Gaara' && player.isShukaku) {
                ctx.fillStyle = '#d6d3d1'; // Sand
                ctx.beginPath(); ctx.arc(0, 18, 8, 0, Math.PI*2); ctx.fill(); // Big hand
            } else if (player.name === 'Sakura' && player.is100Healings) {
                // Glowing hands
                ctx.shadowColor = '#10b981'; ctx.shadowBlur = 10;
                ctx.beginPath(); ctx.arc(0, 18, 3, 0, Math.PI*2); ctx.fill();
                ctx.shadowBlur = 0;
            } else if (player.name === 'Hinata' && player.isTwinLion) {
                // Twin Lion Fists (Blue Chakra Lion Head shape)
                ctx.fillStyle = '#60a5fa'; // Blue
                ctx.shadowColor = '#3b82f6'; ctx.shadowBlur = 15;
                
                ctx.save();
                ctx.translate(0, 20);
                ctx.scale(direction, 1);
                
                ctx.beginPath();
                // Lion head shape simplified
                ctx.moveTo(-5, 0);
                ctx.lineTo(-8, -5); // Ear
                ctx.lineTo(-4, -8); // Top
                ctx.lineTo(4, -8);
                ctx.lineTo(8, -5); // Ear
                ctx.lineTo(5, 0);
                ctx.lineTo(6, 8); // Jaw
                ctx.lineTo(-6, 8); // Jaw
                ctx.closePath();
                ctx.fill();
                
                ctx.restore();
                ctx.shadowBlur = 0;
            } else {
                ctx.beginPath(); ctx.arc(0, 18, 3, 0, Math.PI*2); ctx.fill();
            }
            
            ctx.restore();

            ctx.restore();
            
            // Name Label
            ctx.fillStyle = 'white'; 
 
            ctx.font = '14px "Jockey One"'; 
            ctx.textAlign = 'center';
            if (!isDefeated) ctx.fillText(player.name, x, y + 20);
        }

        function drawTaijutsuHit(ctx, effect) {
            const { x, y, frame } = effect;
            const maxRadius = 25; 
            const duration = 8; 
            const radius = maxRadius * (frame / duration); 
            ctx.save();
            ctx.fillStyle = `rgba(255, 0, 0, ${0.7 - frame / duration})`; 
            ctx.shadowColor = '#FF0000'; ctx.shadowBlur = 10;
            ctx.beginPath(); ctx.arc(x, y, radius, 0, Math.PI * 2); ctx.fill();
            ctx.restore();
        }

        function drawExplosion(ctx, effect) {
            const { x, y, frame } = effect;
            const maxRadius = 50; 
            const duration = 20; 
            const progress = frame / duration;
            
            ctx.save();
            // Core
            ctx.fillStyle = `rgba(255, 200, 0, ${1 - progress})`; 
            ctx.beginPath(); ctx.arc(x, y, maxRadius * progress, 0, Math.PI * 2); ctx.fill();
            
            // Outer
            ctx.strokeStyle = `rgba(255, 69, 0, ${1 - progress})`;
            ctx.lineWidth = 5;
            ctx.beginPath(); ctx.arc(x, y, maxRadius * progress * 1.2, 0, Math.PI * 2); ctx.stroke();
            
            ctx.restore();
        }

        function drawChakraFocus(ctx, effect) {
            const { x, y, frame } = effect;
            const maxRadius = 30; const duration = 40;
            const radius = maxRadius * (frame / duration); 
            ctx.save();
            ctx.strokeStyle = `rgba(16, 185, 129, ${0.7 - frame / duration})`; 
            ctx.fillStyle = `rgba(16, 185, 129, ${0.1 - frame / duration})`;
            ctx.lineWidth = 4; ctx.shadowColor = '#10b981'; ctx.shadowBlur = 10;
            ctx.beginPath(); ctx.arc(x, y, radius, 0, Math.PI * 2); ctx.stroke(); ctx.fill();
            ctx.restore();
        }
        
        function drawRasenganProjectile(x, y, frame, startX, targetX) {
            ctx.save();
            ctx.shadowColor = '#3b82f6'; ctx.shadowBlur = 25;
            const dir = targetX > startX ? 1 : -1;
            
            // Trail
            ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x - 50 * dir, y); 
            ctx.strokeStyle = 'rgba(59, 130, 246, 0.3)'; ctx.lineWidth = 20; ctx.lineCap = 'round'; ctx.stroke();

            // Core
            const scale = 1 + Math.sin(frame * 0.5) * 0.1;
            ctx.translate(x, y);
            ctx.scale(scale, scale);
            
            // Inner Core
            ctx.fillStyle = '#eff6ff'; ctx.beginPath(); ctx.arc(0, 0, 12, 0, Math.PI * 2); ctx.fill();
            
            // Outer Shell (Spinning)
            ctx.rotate(frame * 0.5);
            ctx.strokeStyle = '#60a5fa'; ctx.lineWidth = 3;
            for(let i=0; i<4; i++) {
                ctx.beginPath(); ctx.arc(0, 0, 18, i * Math.PI/2, i * Math.PI/2 + 1); ctx.stroke();
            }
            
            // Particles
            ctx.fillStyle = '#93c5fd';
            for(let i=0; i<5; i++) {
                const angle = Math.random() * Math.PI * 2;
                const dist = 20 + Math.random() * 10;
                ctx.beginPath(); ctx.arc(Math.cos(angle)*dist, Math.sin(angle)*dist, 2, 0, Math.PI*2); ctx.fill();
            }

            ctx.restore();
        }

        function drawChidori(x, y, frame) {
            ctx.save();
            ctx.shadowColor = '#bae6fd'; ctx.shadowBlur = 20;
            
            // Core Glow
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.beginPath(); ctx.arc(x, y, 15, 0, Math.PI * 2); ctx.fill();

            // Lightning Bolts
            ctx.strokeStyle = '#e0f2fe'; ctx.lineWidth = 2;
            const numBolts = 8;
            for (let i = 0; i < numBolts; i++) {
                ctx.beginPath();
                let startX = x; let startY = y;
                ctx.moveTo(startX, startY);
                for (let j = 0; j < 4; j++) {
                    startX += (Math.random() - 0.5) * 30;
                    startY += (Math.random() - 0.5) * 30;
                    ctx.lineTo(startX, startY);
                }
                ctx.stroke();
            }
            
            // Sparks
            ctx.fillStyle = '#7dd3fc';
            for(let i=0; i<5; i++) {
                ctx.beginPath(); 
                ctx.arc(x + (Math.random()-0.5)*40, y + (Math.random()-0.5)*40, 2, 0, Math.PI*2); 
                ctx.fill();
            }
            
            ctx.restore();
        }

        function drawSharinganEffect(ctx, x, y, frame) {
            ctx.save();
            
            // Darken background
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            const opacity = Math.min(1, Math.sin(frame * 0.15) * 0.5 + 0.8); 
            ctx.globalAlpha = opacity;
            
            const eyeSpacing = 160;
            const eyeY = y - 40;
            
            function drawEye(ex, ey) {
                // Eye Shape (Red)
                ctx.fillStyle = '#dc2626'; 
                ctx.shadowColor = '#ef4444';
                ctx.shadowBlur = 20;
                ctx.beginPath();
                ctx.ellipse(ex, ey, 90, 55, 0, 0, Math.PI*2);
                ctx.fill();
                ctx.shadowBlur = 0;
                
                // Pupil (Black)
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(ex, ey, 18, 0, Math.PI*2);
                ctx.fill();
                
                // Tomoe Ring
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(ex, ey, 35, 0, Math.PI*2);
                ctx.stroke();

                // Tomoe (Comma shapes)
                ctx.fillStyle = '#000';
                for(let i=0; i<3; i++) {
                    const angle = (frame * -0.2) + (i * Math.PI * 2 / 3) - Math.PI/2;
                    const tx = ex + Math.cos(angle) * 35;
                    const ty = ey + Math.sin(angle) * 35;
                    
                    ctx.beginPath();
                    ctx.arc(tx, ty, 10, 0, Math.PI*2);
                    ctx.fill();
                }
            }

            drawEye(x - eyeSpacing/2, eyeY);
            drawEye(x + eyeSpacing/2, eyeY);
            
            ctx.restore();
        }

        function drawRinneganProjectile(x, y, frame) {
            ctx.save();
            
            const size = 35; // Radius of the projectile

            // Outer Glow to show it's energy
            ctx.shadowColor = '#a855f7'; // Purple glow
            ctx.shadowBlur = 20;

            // Main Eye Circle (Rinnegan Base Color - Light Purple/Grey)
            // Using a gradient to give it a spherical look
            const grad = ctx.createRadialGradient(x, y, 5 * size, x, y, 30 * size);
            grad.addColorStop(0, '#e9d5ff'); // Center light
            grad.addColorStop(1, '#c084fc'); // Edge darker
            ctx.fillStyle = grad;
            
            ctx.beginPath();
            ctx.arc(x, y, size, 0, Math.PI*2);
            ctx.fill();
            
            // Reset shadow for internal details so lines are crisp
            ctx.shadowBlur = 0;

            // Rings (The Ripple Pattern)
            ctx.strokeStyle = '#4c1d95'; // Deep purple/blackish
            ctx.lineWidth = 2;
            
            // Draw concentric rings
            const ringCount = 5;
            const spacing = size / (ringCount + 1);
            
            for(let i = 1; i <= ringCount; i++) {
                ctx.beginPath();
                ctx.arc(x, y, i * spacing, 0, Math.PI*2);
                ctx.stroke();
            }

            // Center Pupil
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, Math.PI*2);
            ctx.fill();

            // Eye Shine (Reflection)
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.beginPath();
            ctx.ellipse(x - size*0.4, y - size*0.4, 8, 5, Math.PI/4, 0, Math.PI*2);
            ctx.fill();

            ctx.restore();
        }

        function drawSandEffect(x, y, frame, targetX, color = '#d6d3d1') {
            ctx.save();
            const dir = targetX > x ? 1 : -1;
            
            // Sand Cloud
            ctx.fillStyle = color; 
            ctx.strokeStyle = color;
            
            const numParticles = 20;
            for(let i=0; i<numParticles; i++) {
                const px = x + (targetX - x) * (frame/30) + Math.sin(frame * 0.5 + i) * 20;
                const py = y + Math.cos(frame * 0.5 + i) * 20;
                const size = 5 + Math.random() * 5;
                
                ctx.beginPath();
                ctx.arc(px, py, size, 0, Math.PI*2);
                ctx.fill();
            }
            
            // Giant Hand at end
            if (frame > 20) {
                const progress = (frame - 20) / 10;
                const handX = targetX;
                const handY = y;
                
                ctx.globalAlpha = progress;
                ctx.fillStyle = '#a8a29e';
                ctx.beginPath();
                ctx.arc(handX, handY, 40 * progress, 0, Math.PI*2);
                ctx.fill();
                
                // Fingers
                for(let i=0; i<5; i++) {
                    const angle = (i * Math.PI / 4) - Math.PI/2;
                    const fx = handX + Math.cos(angle) * 50 * progress;
                    const fy = handY + Math.sin(angle) * 50 * progress;
                    ctx.beginPath();
                    ctx.moveTo(handX, handY);
                    ctx.lineTo(fx, fy);
                    ctx.lineWidth = 10 * progress;
                    ctx.stroke();
                }
            }
            
            ctx.restore();
        }

        function drawKamuiEffect(x, y, frame) {
            ctx.save();
            
            // Darken background slightly
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            const maxRadius = 100;
            const progress = frame / 30;
            
            // Swirling distortion
            ctx.translate(x, y);
            ctx.rotate(frame * 0.5);
            
            for(let i=0; i<10; i++) {
                ctx.beginPath();
                ctx.strokeStyle = `rgba(0, 0, 0, ${1 - progress})`;
                ctx.lineWidth = 2 + i;
                const r = (maxRadius * progress) + (i * 5);
                ctx.arc(0, 0, r, 0, Math.PI * 1.5);
                ctx.stroke();
                ctx.rotate(Math.PI / 5);
            }
            
            // Center black hole
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(0, 0, 10 * progress, 0, Math.PI*2);
            ctx.fill();
            
            ctx.restore();
        }

        function draw8TrigramsEffect(x, y, frame) {
            ctx.save();
            
            // Green circle on ground
            ctx.translate(x, y + 20); // Ground level
            ctx.scale(1, 0.3); // Perspective
            
            const maxRadius = 120;
            const progress = Math.min(1, frame / 10);
            
            ctx.beginPath();
            ctx.arc(0, 0, maxRadius * progress, 0, Math.PI*2);
            ctx.fillStyle = 'rgba(16, 185, 129, 0.2)'; // Green tint
            ctx.fill();
            ctx.strokeStyle = '#10b981';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Trigram symbols (simplified lines)
            if (frame > 10) {
                for(let i=0; i<8; i++) {
                    ctx.rotate(Math.PI/4);
                    ctx.beginPath();
                    ctx.moveTo(maxRadius - 20, 0);
                    ctx.lineTo(maxRadius, 0);
                    ctx.stroke();
                }
            }
            
            ctx.restore();
        }

        function drawBackground() {
            if (gameState.arena === 'Valley') {
                // Sky Gradient
                const grad = ctx.createLinearGradient(0, 0, 0, H);
                grad.addColorStop(0, '#3b82f6'); grad.addColorStop(1, '#93c5fd');
                ctx.fillStyle = grad; ctx.fillRect(0, 0, W, H);

                // Waterfall
                const wfW = 140;
                const wfX = W/2 - wfW/2;
                
                // Main Body (Gradient for depth)
                const wfGrad = ctx.createLinearGradient(wfX, 0, wfX + wfW, 0);
                wfGrad.addColorStop(0, '#7dd3fc'); // Edge
                wfGrad.addColorStop(0.2, '#e0f2fe'); // Lighter
                wfGrad.addColorStop(0.5, '#ffffff'); // Center shine
                wfGrad.addColorStop(0.8, '#e0f2fe');
                wfGrad.addColorStop(1, '#7dd3fc');
                ctx.fillStyle = wfGrad; 
                ctx.fillRect(wfX, 0, wfW, H);

                // Flow Lines (Animated)
                if (!gameState.waterfallParticles) gameState.waterfallParticles = [];
                if (gameState.waterfallParticles.length === 0) {
                    for(let i=0; i<50; i++) {
                        gameState.waterfallParticles.push({
                            x: wfX + Math.random() * wfW,
                            y: Math.random() * H,
                            h: 10 + Math.random() * 40,
                            w: 1 + Math.random() * 2,
                            speed: 3 + Math.random() * 2 // Slower falling speed
                        });
                    }
                }

                ctx.fillStyle = 'rgba(255,255,255, 0.7)'; 
                gameState.waterfallParticles.forEach(p => {
                    p.y += p.speed;
                    if (p.y > H) {
                        p.y = -p.h;
                        p.x = wfX + Math.random() * wfW;
                    }
                    ctx.fillRect(p.x, p.y, p.w, p.h);
                });

                // Mist/Splash at bottom
                const mistGrad = ctx.createRadialGradient(W/2, GROUND_Y, 20, W/2, GROUND_Y, 90);
                mistGrad.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
                mistGrad.addColorStop(1, 'rgba(255, 255, 255, 0)');
                ctx.fillStyle = mistGrad;
                ctx.fillRect(wfX - 20, GROUND_Y - 50, wfW + 40, 60);

                // Statues (Hashirama & Madara)
                ctx.fillStyle = '#64748b'; // Rock color

                // Left Statue (Hashirama)
                ctx.beginPath();
                ctx.moveTo(0, H);
                ctx.lineTo(0, 20); // High cliff back
                // Head
                ctx.lineTo(40, 20);
                ctx.bezierCurveTo(40, 5, 90, 5, 90, 20); // Smooth hair/head
                ctx.lineTo(90, 50); // Face
                // Body/Robes
                ctx.lineTo(120, 60); // Shoulder
                ctx.lineTo(120, 150); // Arm
                ctx.lineTo(160, H); // Base
                ctx.lineTo(0, H);
                ctx.fill();

                // Right Statue (Madara)
                ctx.beginPath();
                ctx.moveTo(W, H);
                ctx.lineTo(W, 20);
                // Head (Spiky Hair)
                ctx.lineTo(W-40, 20);
                ctx.lineTo(W-45, 5); // Spike
                ctx.lineTo(W-65, 0); // Top Spike
                ctx.lineTo(W-85, 5); // Spike
                ctx.lineTo(W-90, 20);
                ctx.lineTo(W-90, 50); // Face
                // Body/Robes
                ctx.lineTo(W-120, 60); // Shoulder
                ctx.lineTo(W-120, 150); // Arm
                ctx.lineTo(W-160, H); // Base
                ctx.lineTo(W, H);
                ctx.fill();
                
                // Details/Shadows on statues
                ctx.fillStyle = '#475569';
                // Left eyes/mouth lines
                ctx.fillRect(80, 35, 5, 2);
                // Right eyes/mouth lines
                ctx.fillRect(W-85, 35, 5, 2);

                // Water Surface
                ctx.fillStyle = '#0ea5e9'; ctx.fillRect(0, GROUND_Y, W, H - GROUND_Y);
                
            } else if (gameState.arena === 'Forest') {
                // Forest of Death - Realistic
                
                // 1. Sky (Dark & Ominous)
                const skyGrad = ctx.createLinearGradient(0, 0, 0, H);
                skyGrad.addColorStop(0, '#0f172a'); // Slate 900
                skyGrad.addColorStop(1, '#312e81'); // Indigo 900
                ctx.fillStyle = skyGrad;
                ctx.fillRect(0, 0, W, H);

                // 2. Far Background Trees (Dense Forest)
                ctx.fillStyle = '#1e1b4b'; // Very dark indigo
                for(let i=0; i<20; i++) {
                    const h = 100 + Math.random() * 100;
                    const w = 40 + Math.random() * 30;
                    const x = Math.random() * W;
                    ctx.fillRect(x, GROUND_Y - h, w, h);
                    // Triangle tops
                    ctx.beginPath();
                    ctx.moveTo(x, GROUND_Y - h);
                    ctx.lineTo(x + w/2, GROUND_Y - h - 30);
                    ctx.lineTo(x + w, GROUND_Y - h);
                    ctx.fill();
                }

                // 3. Mid-ground Giant Trunks
                for(let i=0; i<6; i++) {
                    const x = i * 180 + 30;
                    const w = 80;
                    const trunkGrad = ctx.createLinearGradient(x, 0, x+w, 0);
                    trunkGrad.addColorStop(0, '#27272a');
                    trunkGrad.addColorStop(0.5, '#52525b');
                    trunkGrad.addColorStop(1, '#27272a');
                    ctx.fillStyle = trunkGrad;
                    ctx.fillRect(x, 0, w, GROUND_Y);
                    
                    // Bark details
                    ctx.strokeStyle = '#18181b';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    for(let j=0; j<GROUND_Y; j+=30) {
                        ctx.moveTo(x + 10, j);
                        ctx.quadraticCurveTo(x + w/2, j+15, x + w - 10, j);
                    }
                    ctx.stroke();
                }

                // 4. Ground
                const groundGrad = ctx.createLinearGradient(0, GROUND_Y, 0, H);
                groundGrad.addColorStop(0, '#14532d'); // Green 900
                groundGrad.addColorStop(1, '#052e16'); // Green 950
                ctx.fillStyle = groundGrad;
                ctx.fillRect(0, GROUND_Y, W, H - GROUND_Y);

                // 5. Fence (Chain Link)
                ctx.strokeStyle = 'rgba(161, 161, 170, 0.5)'; // Zinc 400 transparent
                ctx.lineWidth = 1;
                const fenceH = 40; // Reduced height by half (was 80)
                const fenceY = GROUND_Y - fenceH;
                
                // Mesh
                ctx.beginPath();
                for(let x=-20; x<W; x+=20) {
                    ctx.moveTo(x, fenceY);
                    ctx.lineTo(x+20, GROUND_Y);
                    ctx.moveTo(x+20, fenceY);
                    ctx.lineTo(x, GROUND_Y);
                }
                ctx.stroke();
                
                // Rails & Posts
                ctx.strokeStyle = '#71717a';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(0, fenceY); ctx.lineTo(W, fenceY); // Top rail
                ctx.moveTo(0, GROUND_Y); ctx.lineTo(W, GROUND_Y); // Bottom rail
                ctx.stroke();
                
                // Posts
                ctx.fillStyle = '#52525b';
                for(let x=0; x<=W; x+=150) {
                    ctx.fillRect(x-4, fenceY, 8, fenceH);
                    ctx.fillStyle = '#3f3f46'; // Post cap
                    ctx.beginPath(); ctx.arc(x, fenceY, 5, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle = '#52525b'; // Reset
                }
                
                // 6. Warning Sign
                ctx.fillStyle = '#fef08a'; // Yellow
                ctx.fillRect(W/2 - 40, fenceY + 5, 80, 25); // Adjusted position
                ctx.fillStyle = '#000';
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center'; // Center text
                ctx.fillText('HIGH VOLTAGE', W/2, fenceY + 20); // Centered text coordinates
            } else {
                // Leaf Village
                
                // 1. Sky (Bright Blue)
                const skyGrad = ctx.createLinearGradient(0, 0, 0, H);
                skyGrad.addColorStop(0, '#38bdf8'); // Sky 400
                skyGrad.addColorStop(1, '#bae6fd'); // Sky 200
                ctx.fillStyle = skyGrad; ctx.fillRect(0, 0, W, H);

                // 2. Clouds
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                for(let i=0; i<5; i++) {
                    const cx = (i * 200) + 50;
                    const cy = 50 + (i % 2) * 30;
                    ctx.beginPath();
                    ctx.arc(cx, cy, 30, 0, Math.PI*2);
                    ctx.arc(cx+20, cy-10, 35, 0, Math.PI*2);
                    ctx.arc(cx+40, cy, 30, 0, Math.PI*2);
                    ctx.fill();
                }

                // 3. Hokage Rock (Background Mountain)
                ctx.fillStyle = '#d6d3d1'; // Stone 300
                ctx.beginPath();
                ctx.moveTo(0, H);
                ctx.lineTo(0, 100);
                // Mountain range
                for(let x=0; x<=W; x+=50) {
                    ctx.lineTo(x, 100 - Math.random()*20);
                }
                ctx.lineTo(W, 100);
                ctx.lineTo(W, H);
                ctx.fill();

                // Faces (Simplified)
                ctx.fillStyle = '#a8a29e'; // Stone 400
                for(let i=0; i<4; i++) {
                    const fx = 150 + (i * 150);
                    const fy = 150;
                    // Face shape
                    ctx.beginPath();
                    ctx.arc(fx, fy, 40, 0, Math.PI, false); // Chin
                    ctx.lineTo(fx-40, fy-20); // Forehead left
                    ctx.lineTo(fx+40, fy-20); // Forehead right
                    ctx.fill();
                    // Eyes/Nose shadow
                    ctx.fillStyle = '#78716c';
                    ctx.fillRect(fx-15, fy-10, 10, 2);
                    ctx.fillRect(fx+5, fy-10, 10, 2);
                    ctx.fillRect(fx-2, fy, 4, 10);
                    ctx.fillStyle = '#a8a29e'; // Reset
                }

                // 4. Buildings (Midground)
                ctx.fillStyle = '#ef4444'; // Red roofs
                for(let i=0; i<10; i++) {
                    const bx = i * 100;
                    const by = GROUND_Y - 60;
                    // Roof
                    ctx.beginPath();
                    ctx.moveTo(bx - 10, by);
                    ctx.lineTo(bx + 40, by - 30);
                    ctx.lineTo(bx + 90, by);
                    ctx.fill();
                    // Building body
                    ctx.fillStyle = '#fef3c7'; // Cream walls
                    ctx.fillRect(bx, by, 80, 60);
                    // Windows
                    ctx.fillStyle = '#78350f';
                    ctx.fillRect(bx + 10, by + 10, 20, 20);
                    ctx.fillRect(bx + 50, by + 10, 20, 20);
                    
                    ctx.fillStyle = '#ef4444'; // Reset for next roof
                }

                // 5. Ground
                const groundGrad = ctx.createLinearGradient(0, GROUND_Y, 0, H);
                groundGrad.addColorStop(0, '#d4d4d8'); // Grey pavement
                groundGrad.addColorStop(1, '#a1a1aa');
                ctx.fillStyle = groundGrad;
                ctx.fillRect(0, GROUND_Y, W, H - GROUND_Y);
            }
        }


        function drawCanvasContent() {
            ctx.save();
            // Screen Shake
            if (gameState.screenShake > 0) {
                const dx = (Math.random() - 0.5) * gameState.screenShake;
                const dy = (Math.random() - 0.5) * gameState.screenShake;
                ctx.translate(dx, dy);
                gameState.screenShake *= 0.9;
                if (gameState.screenShake < 0.5) gameState.screenShake = 0;
            }

            drawBackground();

            drawCharacter(gameState.playerA, ctx);
            drawCharacter(gameState.playerB, ctx);
            drawFloatingTexts(ctx);

            gameState.effects = gameState.effects.filter(effect => {
                if (effect.type === 'TaijutsuHit') {
                    if (effect.frame < 8) { drawTaijutsuHit(ctx, effect); effect.frame++; return true; }
                } else if (effect.type === 'ChakraFocus') {
                    if (effect.frame < 40) { drawChakraFocus(ctx, effect); effect.frame++; return true; }
                } else if (effect.type === 'Explosion') {
                    if (effect.frame < 20) { drawExplosion(ctx, effect); effect.frame++; return true; }
                }
                return false;
            });
            
            ctx.restore();
        }

        // --- Animations ---

        function animateTaijutsu(attacker, target, isUltimate = false) {
            const startX = attacker.x;
            const targetX = target.x;
            const targetY = target.y - 20;
            const animationDuration = isUltimate ? 20 : 10; 

            return new Promise(resolve => {
                let frame = 0;
                function step() {
                    frame++;
                    const progress = frame / animationDuration;
                    
                    if(isUltimate) {
                        ctx.fillStyle = 'rgba(21, 128, 61, 0.2)'; // Green trail
                        ctx.fillRect(attacker.x - 5, attacker.y - 50, 10, 50);
                    }

                    if (frame <= animationDuration / 2) {
                        attacker.x = startX + (target.x - startX) * progress * 2 * 0.85; 
                    } else if (frame <= animationDuration) {
                        attacker.x = target.x - (target.x - startX) * (frame - animationDuration / 2) * 2 / animationDuration * 0.85;
                    } else {
                        attacker.x = startX;
                        gameState.effects.push({ type: 'TaijutsuHit', x: targetX, y: targetY, frame: 0 });
                        gameState.screenShake = isUltimate ? 15 : 5; // Trigger Shake
                        resolve(); return;
                    }
                    requestAnimationFrame(step);
                }
                requestAnimationFrame(step);
            });
        }

        function animateKamuiStrike(attacker, target) {
            const startX = attacker.x;
            const startY = attacker.y;
            const targetX = target.x;
            const targetY = target.y;
            const isPlayerA = attacker === gameState.playerA;
            const direction = isPlayerA ? 1 : -1;
            
            const warpX = (target === gameState.playerB) ? targetX + 60 : targetX - 60;

            return new Promise(resolve => {
                let frame = 0;
                
                function step() {
                    frame++;
                    drawCanvasContent();
                    
                    // Phase 1: Disappear into Portal (0-30)
                    if (frame < 30) {
                        const portalX = startX + (40 * direction);
                        drawKamuiEffect(portalX, startY - 30, frame);
                        
                        if (frame < 20) {
                             attacker.x += 1 * direction;
                        }
                        if (frame === 20) {
                            attacker.x = -1000; // Hide offscreen
                        }
                    }
                    
                    // Phase 2: Appear behind and Punch (30-70)
                    else if (frame < 70) {
                        const portalX = warpX;
                        drawKamuiEffect(portalX, targetY - 30, frame - 30);
                        
                        if (frame === 30) {
                            attacker.x = warpX; // Teleport
                            attacker.pose = 'punching'; 
                        }
                        
                        if (frame > 30 && frame < 45) {
                            // Walk out / Dash to target
                            attacker.x -= 2 * direction; 
                        }
                        
                        if (frame === 45) {
                            // Impact
                            gameState.effects.push({ type: 'Explosion', x: targetX, y: targetY - 30, frame: 0 });
                            gameState.screenShake = 10;
                        }
                    }
                    
                    // Phase 3: Return into Portal (70-100)
                    else if (frame < 100) {
                         const portalX = warpX;
                         drawKamuiEffect(portalX, targetY - 30, frame - 70);
                         
                         if (frame === 70) {
                             attacker.pose = 'idle';
                         }

                         if (frame > 70 && frame < 85) {
                             attacker.x += 2 * direction; // Walk back into portal
                         }
                         if (frame === 85) {
                             attacker.x = -1000; // Hide
                         }
                    }
                    
                    // Phase 4: Reappear at start (100-130)
                    else if (frame < 130) {
                        const portalX = startX + (40 * direction);
                        drawKamuiEffect(portalX, startY - 30, frame - 100);
                        
                        if (frame === 100) {
                            attacker.x = startX + (40 * direction);
                            attacker.pose = 'idle';
                        }
                        if (frame > 100) {
                            attacker.x -= 1 * direction; // Walk out to start pos
                        }
                    }
                    else {
                        attacker.x = startX;
                        resolve();
                        return;
                    }
                    
                    requestAnimationFrame(step);
                }
                step();
            });
        }

        function animateNinjutsu(attacker, target, jutsuType) {
            if (jutsuType === 'Kamui Strike') {
                return animateKamuiStrike(attacker, target);
            }
            const offsetX = (attacker === gameState.playerA) ? CHAR_SIZE * 0.7 : -CHAR_SIZE * 0.7;
            const startX = attacker.x + offsetX;
            const startY = attacker.y - 30;
            const targetOffsetX = (target === gameState.playerB) ? 15 : -15;
            const targetX = target.x + targetOffsetX;
            const targetY = target.y - 30;
            const animationDuration = 30; 

            return new Promise(resolve => {
                let frame = 0;
                function step() {
                    frame++;
                    const progress = frame / animationDuration;
                    if (frame < animationDuration) {
                        const currentX = startX + (targetX - startX) * progress;
                        const currentY = startY + (targetY - startY) * progress;
                        drawCanvasContent(); 
                        if (jutsuType === 'Rasengan') {
                            drawRasenganProjectile(currentX, currentY, frame, startX, targetX);
                        } else if (jutsuType === 'Beast Ball') {
                            drawBeastBall(currentX, currentY, frame, startX, targetX);
                        } else if (jutsuType === 'Sharingan' || jutsuType === 'Tsukuyomi') {
                            drawSharinganEffect(ctx, W/2, H/2, frame);
                        } else if (jutsuType === 'Almighty Push') {
                            drawRinneganProjectile(currentX, currentY, frame);
                        } else if (jutsuType === 'Fireball' || jutsuType === 'Majestic Flame') {
                            drawFireball(currentX, currentY, frame, startX, targetX, jutsuType === 'Majestic Flame');
                        } else if (jutsuType === 'Sand') {
                            drawSandEffect(startX, startY, frame, targetX);
                        } else if (jutsuType === 'Kamui') {
                            drawKamuiEffect(targetX, targetY - 30, frame); // Kamui happens on target
                        } else if (jutsuType === 'Meteor Drop') {
                            drawMeteor(targetX, targetY, frame);
                        } else if (jutsuType === '8 Trigrams') {
                            draw8TrigramsEffect(startX, startY, frame);
                        } else if (jutsuType === 'Giant Beast Bomb') {
                            drawBeastBall(currentX, currentY, frame, startX, targetX); // Reuse Beast Ball but maybe bigger?
                        } else if (jutsuType === 'Slash') {
                            // Simple slash effect
                            ctx.save();
                            ctx.strokeStyle = '#fff';
                            ctx.lineWidth = 5;
                            ctx.beginPath();
                            ctx.moveTo(targetX - 20, targetY - 20);
                            ctx.lineTo(targetX + 20, targetY + 20);
                            ctx.stroke();
                            ctx.restore();
                        } else if (jutsuType === 'Nine Tails Whip') {
                             // Whip effect
                             ctx.save();
                             ctx.strokeStyle = '#f97316';
                             ctx.lineWidth = 8;
                             ctx.beginPath();
                             ctx.moveTo(startX, startY);
                             ctx.quadraticCurveTo((startX+targetX)/2, startY - 50, targetX, targetY);
                             ctx.stroke();
                             ctx.restore();
                        } else if (jutsuType === 'Ten Tails Swipe') {
                             // Swipe effect
                             ctx.save();
                             ctx.strokeStyle = '#d4d4d8';
                             ctx.lineWidth = 10;
                             ctx.beginPath();
                             ctx.moveTo(startX, startY);
                             ctx.lineTo(targetX, targetY);
                             ctx.stroke();
                             ctx.restore();
                        } else if (jutsuType === 'Cataclysm') {
                             // Earth shake / debris
                             ctx.save();
                             ctx.fillStyle = '#78350f';
                             ctx.fillRect(targetX - 20 + Math.random()*40, targetY, 10, -Math.random()*50);
                             ctx.restore();
                        } else if (jutsuType === 'God Tree Beam') {
                             // Giant Beam
                             ctx.save();
                             ctx.strokeStyle = '#ef4444';
                             ctx.lineWidth = 30;
                             ctx.shadowColor = '#ef4444'; ctx.shadowBlur = 20;
                             ctx.beginPath();
                             ctx.moveTo(startX, startY);
                             ctx.lineTo(targetX, targetY);
                             ctx.stroke();
                             ctx.restore();
                        } else if (jutsuType === 'Six Paths Rasenshuriken') {
                             drawRasenganProjectile(currentX, currentY, frame, startX, targetX);
                        } else if (jutsuType === 'Indra Arrow') {
                             ctx.save();
                             ctx.strokeStyle = '#a855f7'; ctx.lineWidth = 5; ctx.shadowColor = '#a855f7'; ctx.shadowBlur = 20;
                             ctx.beginPath(); ctx.moveTo(startX, startY); ctx.lineTo(currentX, currentY); ctx.stroke();
                             ctx.restore();
                        } else if (jutsuType === 'Night Guy') {
                             ctx.save();
                             ctx.fillStyle = 'rgba(220, 38, 38, 0.8)'; ctx.shadowColor = '#ef4444'; ctx.shadowBlur = 30;
                             ctx.beginPath(); ctx.arc(currentX, currentY, 40, 0, Math.PI*2); ctx.fill();
                             ctx.restore();
                        } else if (jutsuType === 'Gold Tsunami') {
                             drawSandEffect(startX, startY, frame, targetX, '#fcd34d'); 
                        } else if (jutsuType === 'Acid Slime') {
                             ctx.save();
                             ctx.fillStyle = '#86efac'; ctx.shadowColor = '#22c55e'; ctx.shadowBlur = 15;
                             ctx.beginPath(); ctx.arc(currentX, currentY, 25, 0, Math.PI*2); ctx.fill();
                             ctx.restore();
                        } else if (jutsuType === 'Kamui Shuriken') {
                             ctx.save();
                             ctx.fillStyle = '#000'; ctx.shadowColor = '#3b82f6'; ctx.shadowBlur = 20;
                             ctx.translate(currentX, currentY); ctx.rotate(frame * 0.5);
                             ctx.beginPath();
                             for(let i=0; i<4; i++) { ctx.rotate(Math.PI/2); ctx.moveTo(0,0); ctx.lineTo(30, 10); ctx.lineTo(0, 40); ctx.lineTo(-30, 10); }
                             ctx.fill();
                             ctx.restore();
                        } else if (jutsuType === 'Silver Wheel') {
                             ctx.save();
                             ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 20; ctx.shadowColor = '#fff'; ctx.shadowBlur = 20;
                             ctx.beginPath(); ctx.moveTo(startX, startY); ctx.lineTo(currentX, currentY); ctx.stroke();
                             ctx.restore();
                        } else if (jutsuType === 'Yasaka Beads') {
                             ctx.save();
                             ctx.fillStyle = '#ef4444'; ctx.shadowColor = '#ef4444'; ctx.shadowBlur = 20;
                             ctx.beginPath(); ctx.arc(currentX, currentY, 20, 0, Math.PI*2); ctx.fill();
                             ctx.restore();
                        } else if (jutsuType === 'Flying Raijin') {
                             // Yellow Flash
                             ctx.save();
                             ctx.strokeStyle = '#facc15'; ctx.lineWidth = 5; ctx.shadowColor = '#facc15'; ctx.shadowBlur = 20;
                             ctx.beginPath(); ctx.moveTo(startX, startY); ctx.lineTo(targetX, targetY); ctx.stroke();
                             // Kunai
                             ctx.fillStyle = '#000';
                             ctx.translate(currentX, currentY);
                             ctx.rotate(frame * 0.5);
                             ctx.fillRect(-10, -2, 20, 4);
                             ctx.restore();
                        } else if (jutsuType === 'Almighty Push') {
                            drawRinneganProjectile(currentX, currentY, frame);
                        } else if (jutsuType === 'Thunder Strike') {
                            drawThunderStrike(targetX, targetY, frame);
                        } else {
                            drawChidori(currentX, currentY, frame);
                        }
                        requestAnimationFrame(step);
                    } else {
                        gameState.effects.push({ type: 'TaijutsuHit', x: targetX, y: targetY, frame: 0 });
                        gameState.screenShake = 10; // Trigger Shake
                        resolve(); return;
                    }
                }
                requestAnimationFrame(step);
            });
        }

        let lastTime = 0;
        const FPS = 60;
        const frameDuration = 1000 / FPS;

        // --- AI Logic ---

        function cpuAI() {
            if (gameState.turn !== 'B' || (gameState.mode !== 'CPU' && gameState.mode !== 'BOSS') || checkWinCondition()) return;

            const me = gameState.playerB;
            let action = '';

            if (gameState.mode === 'BOSS') {
                const rand = Math.random();
                if (me.name === 'Ten Tails') {
                     if (rand < 0.4) action = 'Ten Tails Swipe';
                     else if (rand < 0.7) action = 'Cataclysm';
                     else action = 'God Tree Beam';
                } else {
                    if (rand < 0.4) action = 'Slash';
                    else if (rand < 0.7) action = 'Nine Tails Whip';
                    else action = 'Giant Beast Bomb';
                }
                window.handleAction('B', 'BossMove', action);
                return;
            }

            let ultimateCost = getUltimateMove(me).cost;
            
            if (me.hp < 30 && me.chakra >= 20) {
                action = 'Chakra';
            } else if (me.chakra >= ultimateCost) {
                action = Math.random() < 0.7 ? 'Ninjutsu' : 'Taijutsu';
            } else {
                action = Math.random() < 0.6 ? 'Taijutsu' : 'Chakra';
            }

            window.handleAction('B', action);
        }

        const clamp = (num, min, max) => Math.min(Math.max(num, min), max);

        function getUltimateMove(player) {
            if (player.name === 'Rock Lee') {
                if (player.isNightGuy) return { name: 'Night Guy', ...MOVES['Night Guy'] };
                if (player.isNinthGate) return { name: 'Primary Lotus', ...MOVES['Primary Lotus'] }; // Keep Lotus or upgrade? Let's keep Lotus for 2nd form
                return { name: 'Primary Lotus', ...MOVES['Primary Lotus'] };
            }
            if (player.name === 'Gaara') {
                if (player.isGoldenSand) return { name: 'Gold Tsunami', ...MOVES['Gold Sand Tsunami'] };
                if (player.isShukaku) return { name: 'Sand Burial', ...MOVES['Sand Burial'] };
                return { name: 'Sand Coffin', ...MOVES['Sand Coffin'] };
            }
            if (player.name === 'Sakura') {
                if (player.isKatsuyu) return { name: 'Acid Slime', ...MOVES['Katsuyu Acid'] };
                if (player.is100Healings) return { name: '100 Healings', ...MOVES['100 Healings Smash'] };
                return { name: 'Super Punch', ...MOVES['Super Punch'] };
            }
            if (player.name === 'Hinata') {
                if (player.isTenseigan) return { name: 'Silver Wheel', ...MOVES['Silver Wheel'] };
                if (player.isTwinLion) return { name: 'Twin Lion Fists', ...MOVES['Twin Lion Fists'] };
                return { name: '8 Trigrams', ...MOVES['8 Trigrams'] };
            }
            if (player.name === 'Kakashi') {
                if (player.isDMS) return { name: 'Kamui Shuriken', ...MOVES['Kamui Shuriken'] };
                if (player.isMangekyou) return { name: 'Kamui', ...MOVES['Kamui'] };
                return { name: 'Lightning Blade', ...MOVES['Lightning Blade'] };
            }
            if (player.name === 'Naruto') {
                if (player.isSixPaths) return { name: '6 Paths RS', ...MOVES['Six Paths Rasenshuriken'] };
                if (player.isThreeTails) return { name: 'Beast Ball', ...MOVES['Beast Ball'] };
                return { name: 'Rasengan', ...MOVES.Rasengan };
            }
            if (player.name === 'Sasuke') {
                if (player.isRinnegan) return { name: 'Indra Arrow', ...MOVES['Indra\'s Arrow'] };
                if (player.isCurseMark) return { name: 'Sharingan', ...MOVES.Sharingan };
                return { name: 'Chidori', ...MOVES.Chidori };
            }
            if (player.name === 'Itachi') {
                if (player.isEdoTensei) return { name: 'Yasaka Beads', ...MOVES['Yasaka Magatama'] };
                if (player.isSusanoo) return { name: 'Tsukuyomi', ...MOVES['Tsukuyomi'] };
                return { name: 'Fireball', ...MOVES['Fireball'] };
            }
            if (player.name === 'Madara') {
                if (player.isSusanoo) return { name: 'Meteor Drop', ...MOVES['Meteor Drop'] };
                return { name: 'Majestic Flame', ...MOVES['Majestic Destroyer Flame'] };
            }
            if (player.name === 'Minato') {
                if (player.isSageMode) return { name: 'Thunder Strike', ...MOVES['Thunder Strike'] };
                return { name: 'Flying Raijin', ...MOVES['Flying Raijin'] };
            }
            if (player.name === 'Obito') {
                return { name: 'Kamui Strike', ...MOVES['Kamui Strike'] };
            }
            if (player.name === 'Pain') {
                return { name: 'Almighty Push', ...MOVES['Almighty Push'] };
            }
            return { name: 'Attack', cost: 999 };
        }

        // --- NEW BEAST BALL EFFECT ---
        function drawBeastBall(x, y, frame, startX, targetX) {
            ctx.save();
            ctx.shadowColor = '#7f1d1d'; ctx.shadowBlur = 30;
            
            // Dark purple core
            ctx.fillStyle = '#4c1d95'; // Violet 900
            ctx.beginPath(); ctx.arc(x, y, 25 + Math.sin(frame*0.5)*2, 0, Math.PI * 2); ctx.fill();
            
            // Black center
            ctx.fillStyle = '#000'; 
            ctx.beginPath(); ctx.arc(x, y, 15, 0, Math.PI * 2); ctx.fill();
            
            // Energy particles (Imploding)
            ctx.strokeStyle = '#a855f7'; // Purple 500
            ctx.lineWidth = 2;
            const numParticles = 8;
            for(let i=0; i<numParticles; i++) {
                const angle = (frame * 0.2) + (i * Math.PI * 2 / numParticles);
                const dist = 35 - (frame % 10);
                const px = x + Math.cos(angle) * dist;
                const py = y + Math.sin(angle) * dist;
                ctx.beginPath(); ctx.moveTo(px, py); ctx.lineTo(x, y); ctx.stroke();
            }
            
            ctx.restore();
        }

        // --- NEW FIREBALL EFFECT ---
        function drawFireball(x, y, frame, startX, targetX, isMajestic = false) {
            ctx.save();
            ctx.shadowColor = '#ef4444'; ctx.shadowBlur = 25;
            const dir = targetX > startX ? 1 : -1;
            
            const sizeMult = isMajestic ? 2.5 : 1; // Bigger for Madara

            // Core
            const gradient = ctx.createRadialGradient(x, y, 5 * sizeMult, x, y, 30 * sizeMult);
            gradient.addColorStop(0, '#fef08a'); // Yellow center
            gradient.addColorStop(0.4, '#f97316'); // Orange
            gradient.addColorStop(1, 'rgba(239, 68, 68, 0)'); // Red fade
            
            ctx.fillStyle = gradient;
            ctx.beginPath(); ctx.arc(x, y, 30 * sizeMult, 0, Math.PI * 2); ctx.fill();
            
            // Trail / Smoke
            const numParticles = 10;
            for(let i=0; i<numParticles; i++) {
                const px = x - (dir * i * 5 * sizeMult) - (frame * dir * 2);
                const py = y + (Math.random() - 0.5) * 20 * sizeMult;
                const size = (20 - i) * sizeMult;
                if(size > 0) {
                    ctx.fillStyle = `rgba(124, 45, 18, ${0.5 - i/20})`; // Brownish smoke
                    ctx.beginPath(); ctx.arc(px, py, size, 0, Math.PI*2); ctx.fill();
                }
            }
            
            ctx.restore();
        }

        function drawMeteor(x, y, frame) {
            ctx.save();
            
            // Shadow growing on ground
            const progress = frame / 30;
            const shadowSize = 100 * progress;
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.beginPath();
            ctx.ellipse(x, y, shadowSize, shadowSize/2, 0, 0, Math.PI*2);
            ctx.fill();

            // Meteor falling
            const startY = -200;
            const currentY = startY + (y - startY) * progress;
            
            ctx.translate(x, currentY);
            ctx.rotate(frame * 0.1);
            
            // Rock texture
            ctx.fillStyle = '#4b5563'; // Grey rock
            ctx.beginPath();
            ctx.arc(0, 0, 80, 0, Math.PI*2);
            ctx.fill();
            
            // Craters
            ctx.fillStyle = '#374151';
            ctx.beginPath(); ctx.arc(-20, -20, 15, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(30, 10, 20, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(-10, 40, 10, 0, Math.PI*2); ctx.fill();
            
            // Fire trail
            ctx.fillStyle = 'rgba(239, 68, 68, 0.5)';
            ctx.beginPath();
            ctx.arc(0, -80, 70, 0, Math.PI, true);
            ctx.fill();

            ctx.restore();
        }

        function drawThunderStrike(x, y, frame) {
            ctx.save();
            
            // Darken sky
            ctx.fillStyle = `rgba(0, 0, 0, ${Math.min(0.5, frame/10)})`;
            ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            const progress = frame / 30;
            
            // Warning circle on ground
            if (frame < 10) {
                ctx.strokeStyle = '#facc15';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(x, y, 40 * (frame/10), 0, Math.PI*2);
                ctx.stroke();
            }

            // Main Bolt
            if (frame >= 10 && frame < 25) {
                ctx.shadowColor = '#fef08a';
                ctx.shadowBlur = 30;
                ctx.strokeStyle = '#fef08a'; // Light yellow
                ctx.lineWidth = 40 + Math.random() * 20;
                ctx.lineCap = 'butt';
                
                ctx.beginPath();
                ctx.moveTo(x, -100);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                // Inner white core
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 15;
                ctx.stroke();
                
                // Side branches
                ctx.lineWidth = 4;
                ctx.strokeStyle = '#facc15';
                for(let i=0; i<5; i++) {
                    const startY = Math.random() * y;
                    ctx.beginPath();
                    ctx.moveTo(x, startY);
                    ctx.lineTo(x + (Math.random()-0.5)*100, startY + 50);
                    ctx.stroke();
                }
            }
            
            // Impact
            if (frame >= 10) {
                const impactFrame = frame - 10;
                ctx.fillStyle = `rgba(253, 224, 71, ${1 - impactFrame/20})`;
                ctx.beginPath();
                ctx.arc(x, y, 30 + impactFrame * 5, 0, Math.PI*2);
                ctx.fill();
            }

            ctx.restore();
        }

        // --- Game Loop Adjustments ---
        function gameLoop(timestamp) {
            requestAnimationFrame(gameLoop);
            if (timestamp < lastTime + frameDuration) return;
            lastTime = timestamp;
            
            // Clear Canvas
            ctx.clearRect(0, 0, W, H);
            
            drawCanvasContent();
            
            // Draw Boss (if in boss mode)
            if (gameState.mode === 'BOSS') {
                drawNineTails(gameState.playerB.x, gameState.playerB.y, 1, gameState.playerB.pose);
                drawBossHealthBar(ctx, gameState.playerB);
            }
        }

        gameLoop(0);
    })();
    </script>
    <div id="version-display" class="fixed bottom-1 right-1 text-[10px] text-gray-500 font-mono opacity-50 pointer-events-none select-none">
        Version 1.0.2
    </div>
</body>
</html>